# Описание
## Описание проблемы
Субподрядчики отчитываются по выполненным работам при помощи отчетов в формате Microsoft Excel. Журнал - самый распространный формат отчета. Он используется для ежемесячного выполнения (форма КС-6), фактического выполнение (ВКС) и факта работ (журналы Велесстрой-Монтажа, Велесстрой-СМУ). Журнал представляет собой формат сводной таблицы у которой в строках задаются аттрибуты работы: позиция контракта, наименование, ед изм и тд, а в столбцах: период выполнения работ, как правило за месяц. На пересечение строк и столбцов заносится факт выполнения работы: объем, затраченные человеческие и технические ресурсы. По мимо этого журнал содержит объемы по контракту, накопительные итоги по столбцам и промежуточные итоги по строкам. Количество журналов варьируется от проекта к проекту, например, на Нижнем-Новгороде количество журналов с фактом выполнения работ достигало 80шт. Размер файла с журналом варьируется в диапазоне от 1 Мб до 300 Мб. 

Ежемесячно аналитик собирает журналы, извлекает информацию  и рассчитывает показатели. Не смотря на то, что показатели варьируются в зависимости от отдела в котором работает аналитик и задач руководства их можно классифицировать на три группы:
- Накопительные показатели за весь период строительства
- Ежемесячные показатели
- Сравнение итоговых и накопительных значений

Основные трудности при работе с журналами:
- Плохая структурированность. В журналах может варьироваться формат шапки (зачастую многострочной), количество и порядок столбцов, количество строк. Большие проблемы создают промежуточные итоги по строкам и столбцам.
- Медленная работа с журналом. В журналах с объемом больше 10 Мб медленно работают фильтры и вставка новых строк и столбцов.
- Постоянно меняющаяся информация. Подрядчик может добавлять и удалять строки и столбцы, изменять значения за предыдущие периоды.

Во время отчетного периода подрядчик может неоднократно заменять журналы, что влечет за собой необходимость постоянного пересчета показателей аналитиком. 

## Определение сделанного (DoD)
Аналитику доступен инструмент при помощи которого он извлекает требуемую информацию из журналов:
- При внесении изменний в журнал инструмент обновляет извлеченные данные согласно новым значениям. 
- Работа аналитика по подготовке журнала к извлечению сведена к минимуму.
- В инструменте должна быть реализована проверка правильности извлечения.
- Текстовой инструкции и примера файла достаточно, чтобы понять как работает инструмент.


## Решение
Для решения задачи используем инструмент Power Query от Microsoft. С его помощью извлекаем данные из сводной двумерной таблицы и преобразовываем в длинный одномерный формат, объеденияем данные проектов в единую таблицу и обогащаем их информацией из справочников. 

Не смотря на то, что для отчета создан шаблон, от проекта к проекту он может видоизменяться. В него могут быть добавлены дополнительные столбцы и число месяцев отличается от проекта к проекту. Шапка состоит из нескольких строк с объединенными ячейками, что приводит к дополнительным трудностям для обработки. Помимо этого в таблицах рассчитываются промежуточные итоги по строкам и столбцам, а на одном листе может находиться несколько таблиц по подпроектам, которые разделенны пустыми строками. 

Для решения проблемы было принято решение добавить первой строкой пользовательскую шапку в которой аналитик указывает столбцы которые необходимо извлечь. Если он указал название столбца или месяца в формате даты, то эти данные попадут в базу, в противном случае они не будут извлечены. Для исключения из базы промежуточных итогов добавлен пользовательский столбец "фильтр" в котором аналитик отмечает строки подлежащие включению в базу. 

## Источники
- папка с файлами баз ключевых часов за месяц, формата xlsx
- справочник(схема)

## Требования для загрузки

### Названия листов в файле Excel


## Чек-лист если не работает

## Структура листов инструмента

### перед первым запуском
Инструкция по отключению конфицендиальности power query

### параметры


### нормализация

### статус извлечения

### ошибки


## Аттрибуты источника

###


## Аттрибуты базы



## Основные операции Power Query

. загружаем пользовательские данные
    . путь к журналам
    . взаимное расположение столбцов в таблицах: контракт, факт
    . параметры
. извлекаем содержимое файлов с журналами
    . нормализуем метаданные: имя листа и файла
    . оставляем файлы с расширением: xlsx, xlsm
    . оставляем заданные пользователем листы. Значение листа задается в параметре PrSheetName на листе параметры
. трансформируем содержимое листов
    . преобразовываем многострочную шапку документа
        . нормализуем и объединяем строки шапки
        . удаляем столбцы для которых не задана шапка
    . добавляем аттрибут с именем файла
    . заменяем пользовательские ошибки в журнале на null
    . раскрываем иерархию
    . исключаем строки у которых не задан индекс
    . проверяем трансформацию файлов на ошибки
. объединяем данные для формирования таблиц: контракт факт по отдельности
    . контракт
        . исключаем таблицы с ошибками при трансформации
        . объединяем таблицы
        . оставляем и переименовываем контрактные столбцы
        . меняем порядок согласно пользовательскому списку
    . факт
        . исключаем таблицы с ошибками при трансформации
        . объединяем таблицы
        . оставляем и переименовываем столбцы с фактом
        . трансформируем столбцы с периодами в строки
        . меняем порядок согласно пользовательскому списку
 

2. из файла схема загружаем таблицы: проект, организация, типовые, классификатор, календарь
3. извлекаем содержимое папки с файлами дополнительных часов (без вложенных папок)  
    1. выводим в отдельный шаг таблицы которые не были извлечены
4. извлекаем таблицу с дополнительными часами. Допустимые имена: "доп_часы", "дополнительные_часы", "_доп_часы_шаблон"
5. нормализуем названия заголовков таблицы: изменяем регистр на нижний и удаляем ведущие пробелы
6. объединяем таблицы по полям из перечня "Аттрибуты источника"  
    1. выводим в отдельный шаг ошибки в таблицах
7. в числовых столбцах заменяем "." на "," 
8. изменяем тип данных согласно перечню "Аттрибуты источника"
9. создаем ключи для полей: "проект", "подпроект", "организация", "классификатор", "типовые"
10. объединяем с таблицами из схемы
11. раздеяем на две таблицы: 1к1н и дополнительные часы. Разделение производим по значениям "1к", "1н" по полю "классификатор_key".  
    1. для таблицы 1к1н оставляем строки с классификаторами 1к 1н и производим pivot  
    2. для таблицы дополнительных часов убираем классификаторы 1к 1н


## Метрики отчета

## Является источником для
- отчет Power BI
- модель

## Требование к ПО
- Microsoft Excel 2019 и выше
