# Описание
## Описание проблемы
Субподрядчики отчитываются по выполненным работам при помощи отчетов в формате Microsoft Excel. Журнал - самый распространный формат отчета. Он используется для ежемесячного выполнения (форма КС-6), фактического выполнение (ВКС) и факта работ (журналы Велесстрой-Монтажа, Велесстрой-СМУ). Журнал представляет собой формат сводной таблицы у которой в строках задаются аттрибуты работы: позиция контракта, наименование, ед изм и тд, а в столбцах: период выполнения работ, как правило за месяц. На пересечение строк и столбцов заносится факт выполнения работы: объем, затраченные человеческие и технические ресурсы. По мимо этого журнал содержит объемы по контракту, накопительные итоги по столбцам и промежуточные итоги по строкам. Количество журналов варьируется от проекта к проекту, например, на Нижнем-Новгороде количество журналов с фактом выполнения работ достигало 80шт. Размер файла с журналом варьируется в диапазоне от 1 Мб до 300 Мб. 

Ежемесячно аналитик собирает журналы, извлекает информацию  и рассчитывает показатели. Не смотря на то, что показатели варьируются в зависимости от отдела в котором работает аналитик и задач руководства их можно классифицировать на три группы:
- Накопительные показатели за весь период строительства
- Ежемесячные показатели
- Сравнение итоговых и накопительных значений

Основные трудности при работе с журналами:
- Плохая структурированность. В журналах может варьироваться формат шапки (зачастую многострочной), количество и порядок столбцов, количество строк. Большие проблемы создают промежуточные итоги по строкам и столбцам.
- Медленная работа с журналом. В журналах с объемом больше 10 Мб медленно работают фильтры и вставка новых строк и столбцов.
- Постоянно меняющаяся информация. Подрядчик может добавлять и удалять строки и столбцы, изменять значения за предыдущие периоды.

Во время отчетного периода подрядчик может неоднократно заменять журналы, что влечет за собой необходимость постоянного пересчета показателей аналитиком. 

## Определение сделанного (DoD)
Аналитику доступен инструмент при помощи которого он извлекает требуемую информацию из журналов:
- При внесении изменний в журнал инструмент обновляет извлеченные данные согласно новым значениям. 
- Работа аналитика по подготовке журнала к извлечению сведена к минимуму.
- В инструменте должна быть реализована проверка правильности извлечения.
- Текстовой инструкции и примера файла достаточно, чтобы понять как работает инструмент.


## Решение
Для решения задачи используем инструмент Power Query от Microsoft. С его помощью извлекаем данные из сводной двумерной таблицы и преобразовываем в длинный одномерный формат, объеденияем данные проектов в единую таблицу и обогащаем их информацией из справочников. 

Не смотря на то, что для отчета создан шаблон, от проекта к проекту он может видоизменяться. В него могут быть добавлены дополнительные столбцы и число месяцев отличается от проекта к проекту. Шапка состоит из нескольких строк с объединенными ячейками, что приводит к дополнительным трудностям для обработки. Помимо этого в таблицах рассчитываются промежуточные итоги по строкам и столбцам, а на одном листе может находиться несколько таблиц по подпроектам, которые разделенны пустыми строками. 

Для решения проблемы было принято решение добавить первой строкой пользовательскую шапку в которой аналитик указывает столбцы которые необходимо извлечь. Если он указал название столбца или месяца в формате даты, то эти данные попадут в базу, в противном случае они не будут извлечены. Для исключения из базы промежуточных итогов добавлен пользовательский столбец "фильтр" в котором аналитик отмечает строки подлежащие включению в базу. 

## Источники
- папка с файлами баз ключевых часов за месяц, формата xlsx
- справочник(схема)

## Требования для загрузки

### Названия листов в файле Excel
- Ключевые объемы
- ЛР по видам работ
- Тех.Ресурсы

- Пользовательская первая строка. Для каждого листа создан свой шаблон строки.

## Чек-лист если не работает

## Структура листов инструмента

### перед первым запуском
Инструкция по отключению конфицендиальности power query

### параметры
Здесь задаем пути к источникам

### нормализация

### статус извлечения

### ошибки


### ключевые объемы
Результат извлечения из листов "Ключевые объемы"

### ключевые часы
Результат извлечения из листов "ЛР по видам работ"

### ключевые техника
Результат извлечения из листов "Тех.Ресурсы"

## Аттрибуты источника

###
| аттрибут        | описание                                 | тип данных |
|-----------------|------------------------------------------|------------|
| дата            | месяц выполнения работы  (начало месяца) | дата       |
| проект          | проект по справочнику                    | текст      |
| подпроект       | подпроект по справочнику                 | текст      |
| организация     | организация по справочнику               | текст      |
| классификатор   | классификатор работы по справочнику      | текст      |
| работа описание | описание выполненной работы              | текст      |
| работа группа   | шифр дисциплины                          | текст      |
| типовые         | типовой код по справочнику               | текст      |
| часы            | затраченные людские ресурсы              | число      |
| стоимость руб   | стоиомость работы в рублях               | число      |

## Аттрибуты базы
| аттрибут                        | источник             | формула вычисления                     | тип данных |
|---------------------------------|----------------------|----------------------------------------|------------|
| дата                            | источник             |                                        | дата       |
| схема.год                       | схема, календарь     |                                        | текст      |
| схема.месяц                     | схема, календарь     |                                        | текст      |
| проект                          | источник             |                                        | текст      |
| подпроект                       | источник             |                                        | текст      |
| проект_key                      | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                    | схема, проект        |                                        | текст      |
| схема.подпроект                 | схема, проект        |                                        | текст      |
| организация                     | источник             |                                        | текст      |
| организация_key                 | вычисление           | lower(организация)                     | текст      |
| схема.организация               | схема, организация   |                                        | текст      |
| классификатор                   | источник             |                                        | текст      |
| классификатор_key               | вычисление           | lower(классификатор)                   | текст      |
| схема.классификатор с описанием | схема, классификатор |                                        | текст      |
| работа описание                 | источник             |                                        | текст      |
| работа группа                   | источник             |                                        | текст      |
| типовые                         | источник             |                                        | текст      |
| типовые_key                     | вычисление           | lower(типовые)                         | текст      |
| схема.типовые наименование      | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование  | схема, типовые       |                                        | текст      |
| часы                            | источник             |                                        | число      |
| стоимость руб                   | источник             |                                        | число      |
| имя файла                       | вычисление           | метаданные, имя файла                  | текст      |


## Основные операции Power Query


## Метрики отчета

## Является источником для
- отчет Power BI
- модель

## Требование к ПО
- Microsoft Excel 2019 и выше
