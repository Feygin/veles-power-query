# Описание
## Описание проблемы
Субподрядчики отчитываются по выполненным работам при помощи отчетов в формате Microsoft Excel. Журнал - самый распространный формат отчета. Он используется для ежемесячного выполнения (форма КС-6), фактического выполнение (ВКС) и факта работ (журналы Велесстрой-Монтажа, Велесстрой-СМУ). Журнал представляет собой формат сводной таблицы у которой в строках задаются аттрибуты работы: позиция контракта, наименование, ед изм и тд, а в столбцах: период выполнения работ, как правило за месяц. На пересечение строк и столбцов заносится факт выполнения работы: объем, затраченные человеческие и технические ресурсы. По мимо этого журнал содержит объемы по контракту, накопительные итоги по столбцам и промежуточные итоги по строкам. Количество журналов варьируется от проекта к проекту, например, на Нижнем-Новгороде количество журналов с фактом выполнения работ достигло 80шт. Размер файла с журналом варьируется в диапазоне от 1 Мб до 300 Мб. 

Ежемесячно аналитик извлекает информацию из журналов и рассчитывает показатели. При этом он сталкивается со следующими трудностями:
- Плохая структурированность журналов. Так может варьироваться формат многострочной шапки: количество и порядок столбцов, количество строк. 
- Промежуточные итоги по строкам и столбцам затрудняют рассчет показателей
- Медленная работа с журналом у которого объем больше 10 Мб: фильтация, вставка новых строк и столбцов.
- Постоянно меняющаяся информация: подрядчик может добавлять и удалять строки и столбцы, изменять значения за предыдущие периоды. Это приводит к постоянному пересчету показателей.

## Определение сделанного (DoD)
Аналитику доступен инструмент при помощи которого он собирает информацию из журналов в один файл:
- данные в журнале разделены на две сущности: контракт, факт
- из журнала забираются только те данные, которые нужны пользователю
- раскрыта иерархическая структура контракта
- даты перенесены из столбцов в строки
- журналы объединены в единый файл

Для проверки качества извлечения:
- реализована проверка полноты извлечения

Написана пользовательская инструкция

## Решение
Для решения задачи по извлечению данных используем инструмент Power Query от Microsoft.

### Как задать столбцы, которые попадут в базу

### Как задать строки, которые попадут в базу

### Как раскрыть иерархию

### Как журнал разделяется на две сущности: контракт, факт


Для исключения строк 

Также необходимо исключить промежуточные итоги в строках и другую нерелевантную информацию. Для этого в столбце фильтр пользователь отмечает строки которые будут загружены в базу.  


## Источники
- папка в которой хранятся файлы с журналами

## Требования для загрузки
- файлы с журналами формата xlsx, xlsm
- путь к папке с файлами формата: C:\Users\FeyginAS\Журналы
- на листе параметры задано имя листа для извлечения PrSheetName
- заданы параметры для извлечения иерархии
    - на листе параметры задано имя столбца с иерархией PrLvlDescriptionName
    - в столбце индекс иерархия содержатся только целочисленные значения (-n..n)
- задано взаимное расположение столбцов для таблиц факт, контракт
    - список столбцов может отличаться от источника, но тогда не гарантируется взаимный порядок столбцов
- в первых четырех строках файла заданы столбцы для извлечения 
    - в них присутствуют обязательные столбцы 
    - в этих строках отсутствуют ошибки типа #N/A, #REF
    - в 3 строке шапки задана дата выполнения работ в формате даты 
    - имена во 2 строке блока "факт" не пересекаются с именами 2 строки блока "контракт". Например, в блоке "контракт" и "факт" не может быть двух столбцов с именем "часы". Один из столбцов нужно переименовать, например, "часы накопительно" для блока контракт.
    - не используются зарезервированные имена
        - имя файла
        - ркц ур0..10
- в блоке факт содержатся значения  

### Названия листов в файле Excel


## Чек-лист если не работает

## Структура листов инструмента

### перед первым запуском
Инструкция по отключению конфицендиальности power query

### параметры


### нормализация

### статус извлечения

### ошибки


## Аттрибуты источника

###


## Аттрибуты базы



## Основные операции Power Query

. загружаем пользовательские данные
    . путь к журналам
    . взаимное расположение столбцов в таблицах: контракт, факт
    . параметры
. извлекаем содержимое файлов с журналами
    . нормализуем метаданные: имя листа и файла
    . оставляем файлы с расширением: xlsx, xlsm
    . оставляем заданные пользователем листы. Значение листа задается в параметре PrSheetName на листе параметры
. трансформируем содержимое листов
    . преобразовываем многострочную шапку документа
        . нормализуем и объединяем строки шапки
        . удаляем столбцы для которых не задана шапка
    . добавляем аттрибут с именем файла
    . заменяем пользовательские ошибки в журнале на null
    . раскрываем иерархию
    . исключаем строки у которых не задан индекс
    . проверяем отсутсвие ошибок при трансформации файлов
. объединяем данные для формирования таблиц: контракт факт по отдельности
    . контракт
        . исключаем таблицы с ошибками при трансформации
        . объединяем таблицы
        . оставляем и переименовываем контрактные столбцы
            . столбцы с маркером "контракт" - 1 строчка шапки
            . столбцы иерархии "ркц ур 0..10" - создаются автоматически при извлечении иерархии
            . "имя файла" - создается автоматически из имени файла
        . меняем порядок согласно пользовательскому списку
    . факт
        . исключаем таблицы с ошибками при трансформации
        . объединяем таблицы
        . оставляем и переименовываем столбцы с фактом
            . столбцы с маркером "факт" - 1 строчка шапки
            . столбцы с маркером "контракт" - 1 строчка шапки , но без маркера "факт исключить" - 3 строчка шапки
            . столбцы иерархии "ркц ур 0..10" - создаются автоматически при извлечении иерархии
            . "имя файла" - создается автоматически из имени файла
        . трансформируем столбцы с периодами в строки (unpivot)
            . переносим столбцы с датами в строки (unpivot)
            . исключаем строки без значений за период
            . переносим аттрибуты периода: часы, объем, стоимость и тд., в столбцы (pivot), для повторяющихся строк суммируем значения
            . удаление идентификатора для столбцов с одинаковыми названиями
        . меняем порядок согласно пользовательскому списку

## Проверка работоспособности запроса

. запрос не падает при наличии ошибок в файле
. иерархия корректно раскрылась
. строки без индекса не попали в базу
. файлы с неверным расширением, неверным именем листа и ошибками при трансформации в базу не попадают
    . файлы с ошибками выводятся в отдельную таблицу
. шапка корректно нормализовалась, лишние столбцы удалены
    . в обоих таблицах присутствуют столбцы с уровнями иерархии
    . в обоих таблицах есть имя файла
    . столбцы с маркером "факт исключить" (3 строка шапки) должны быть в таблице "контракт", но отсутствовать в таблице "факт"  
. для факта unpivot выполнился корректно
    . в таблице "факт" отсутствуют индексы без объемов
    . проверяем контрольные суммы
. расположение столбцов соответствует листу "настройка столбцов"

## Метрики отчета

## Является источником для
- отчет Power BI

## Требование к ПО
- Microsoft Excel 2019 и выше
