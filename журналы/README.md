# Описание
## Описание проблемы

Субподрядчики отчитываются о выполненных работах в отчетах в формате Microsoft Excel. Журнал - самая распространненная форма отчета. В него заносятся значения ежемесячного выполнения (форма КС-6), фактического выполнение (ВКС) и факта работ (журналы Велесстрой-Монтажа, Велесстрой-СМУ). По структруте журнал похож на сводную таблицу в строки которой заносятся аттрибуты работы: позиция контракта, наименование, ед изм и тд, а в столбцы: период выполнения работ, как правило месяц, и показатели: затраченные часы, выполненные объемы и тд. На пересечение строк и столбцов заносится значение показателя. По мимо этого журнал содержит итоговые объемы по контракту, накопительные итоги по столбцам и промежуточные итоги по строкам. Количество журналов варьируется от проекта к проекту, например, на Нижнем-Новгороде количество журналов с фактом выполнения работ достигло 80шт. Размер файла с журналом варьируется в диапазоне от 1 Мб до 300 Мб. 

Ежемесячно аналитик извлекает информацию из журналов и рассчитывает показатели. При этом он сталкивается со следующими трудностями:
- Плохая структурированность журналов. Так может варьироваться формат многострочной шапки: количество и порядок столбцов, количество строк. 
- Промежуточные итоги по строкам и столбцам, которые затрудняют рассчет показателей
- Медленная работа с журналом у которого объем больше 10 Мб: фильтация, вставка новых строк и столбцов.
- Изменчивость структуры: подрядчик может добавлять и удалять строки и столбцы
- Непостоянство значений за предыдущие периоды

## Определение сделанного (DoD)

Аналитику доступен инструмент при помощи которого он собирает информацию из журналов в один файл:
- данные разделены на две сущности: контракт, факт
- из журнала забираются только те данные, которые нужны пользователю
- раскрыта иерархическая структура контракта
- даты перенесены из столбцов в строки
- журналы объединены в единый файл

Для проверки качества извлечения:
- реализована проверка полноты извлечения

Написана пользовательская инструкция

## Решение

Для решения задачи по извлечению данных используем инструмент Power Query от Microsoft.

### Как задать столбцы, которые попадут в базу

Не все столбцы журнала должны попасть в базу. При помощи пользовательской шапки пользователь задает столбцы, которые попадут в базу. Шапка располагается в первых 4 строках файлах. Каждая из строк отвечает за определенные метаданные столбца:
- 1 строка. Задаем тип столбца: "контракт" или "факт"
- 2 строка. Ввводим имя столбца: "индекс", "поз ркц", "ркц описание", "объем контракт", "объем факт" и тд 
- 3 строка. Для типа столбца "факт" задаем дату выполнения работы
- 4 строка. Дополнительный идентификатор. С его помощью можно исключить из таблицы "факт" аттрибуты контракта или разделить по группам работы за один период.
    - Чтобы исключить из факта часть аттрибутов контракта используем ключевое слово "факт исключить". Обычно из таблицы факта требуется исключить  контрактные и накопительные значения показателей так как их деталировка отлична от деталировки таблицы факт. Пример аттрибутов для исключения: "объем контракт", "объем накопительно" и тд.
    - Порой в одном периоде используют несколько столбцов для отчета по одному аттрибуту. Так могут поступить в случае корректировки показателя. Для того, чтобы отличить один аттрибут от другого необходимо задать дополнительный идентификатор, например, "корректировка". Если корректировок несколько добавляем новый идентификатор, например, "корректировка 1" и тд. В базе пользователю доступен столбец "идентификатор" при помощи которого он может найти соответствующие значения.

### Как журнал разделяется на две сущности: контракт, факт

Разделение на сущности задается в первой строке шапки. В базу контракт попадают столбцы типа "контракт", а в базу факт столбцы типа "контракт" без идентификатора "факт исключить" и столбцы типа "факт".

### Как задать строки, которые попадут в базу

Не все строки из журнала должны попасть в базу. При помощи индекса пользоваетель задает строки, которые в нее попадут. В качестве индекса можно использовать любой текстовый или числовой символ. Надо помнить, что для базы вм нужно, чтобы значения индекса были уникальными. Для этих целей рекомендуется использовать целые числа c заданной разницей между соседними числами, например, 0,100,200..n. Делается это для упрощения добавления новых индексов, когда в журнал добавляются строки. 

### Как раскрыть иерархию

В журнале может присутствовать аттрибут иерархического типа. Таким аттрибутом в журналах Велесстрой-Монтажа является описание позиции ркц. Иерархию можно представить в виде уровней, где 0 - самый крупный уровень. На примере географического местоположения: 0 - страна -> 1 - округ -> 2 - город и тд. Чтобы преобразовать иерархию в столбцы для группировки нужен вспомогательный столбец. В нем пользователь присваивает иерархии номер уровня. На основании номера уровня запрос создает столбцы для группировки. Важно, чтобы иерархия располагалась последовательно друг под другом: 0 - Россия -> 1 - Центральный округ -> 2 - Москва. 
Пример раскрытия иерархии:

| уровень иерархии | описание ркц          | ркц ур0   | ркц ур1               | ркц ур2      | ркц ур3              |
|------------------|-----------------------|-----------|-----------------------|--------------|----------------------|
| 0                | Россия                | Россия    |                       |              |                      |
| 1                | Центральный округ     | Россия    | Центральный округ     |              |                      |
| 2                | Москва                | Россия    | Центральный округ     | Москва       |                      |
| 1                | Дальневосточный округ | Россия    | Дальневосточный округ |              |                      |
| 2                | Благовещенск          | Россия    | Дальневосточный округ | Благовещенск |                      |
| 3                | Благовещенская улица  | Россия    | Дальневосточный округ | Благовещенск | Благовещенская улица |
| 0                | Казахстан             | Казахстан |                       |              |                      |

*непоследовательное расположение уровней приведет к неверному результату.  0 - Россия -> 2 - Москва -> 1 - Центральный округ*

Для раскрытия иерархии нужно два условия:
1. В журнале проставляем уровни иерархии в столбце "индекс иерархия"
2. В базе (лист параметры, таблица параметры) задаем имя столбца из которого извлекаем значения иерархии 

### Как задать взаимное расположение столбцов таблицы "факт", "контракт"

Взаимное расположение задаем в файле базы на листе "расположение столбцов" 

## Источники

- папка в которой хранятся файлы с журналами

## Требования для загрузки

- файлы с журналами формата xlsx, xlsm
- путь к папке с файлами формата: C:\Users\FeyginAS\Журналы
- на листе параметры задано имя листа для извлечения PrSheetName
- заданы параметры для извлечения иерархии
    - на листе параметры задано имя столбца с иерархией PrLvlDescriptionName
    - в столбце индекс иерархия содержатся только целочисленные значения (-n..n)
- задано взаимное расположение столбцов для таблиц факт, контракт
    - список столбцов может отличаться от источника, но в этом случае не гарантируется взаимный порядок столбцов
- в первых четырех строках файла заданы столбцы для извлечения 
    - в них присутствуют обязательные столбцы 
    - в этих строках отсутствуют ошибки типа #N/A, #REF
    - в 3 строке шапки задана дата выполнения работ в формате даты 
    - имена во 2 строке блока "факт" не пересекаются с именами 2 строки блока "контракт". Например, в блоке "контракт" и "факт" не может быть двух столбцов с именем "часы". Один из столбцов нужно переименовать, например, "часы накопительно" для блока контракт.
    - не используются зарезервированные имена
        - имя файла
        - ркц ур0..10
- в блоке факт содержатся значения  

## Структура листов инструмента

### Перед первым запуском

Инструкция по отключению конфиденциальности

### Параметры

Задаем пути к схеме и папке с журналами. Задаем параметры работы базы.

### Расположение столбцов

Задаем взаимное расположение столбцов в таблицах "факт" и "контракт".

### Статус извлечения

Проверяем, что из всех файлов были извлечены данные

### Контракт

Результат объединения журналов.

### Факт

Результат объединения журналов.

## Аттрибуты источника

### Журнал ВМ

Перечень столбцов, которые будут извлечены из журнала, далее [пользовательские имена столбцов] задаются во второй строчке пользовательской шапке. Далее список обязательных столбцов базы и список зарезервированных имен. Обязательные столбцы должны присутствовать в полном объеме в каждом файле журнала во второй строчке. Зарезервированные имена напротив запрещается использовать в качестве имен столбцов.

| аттрибут                          | описание                                                                                       | тип данных              |
|-----------------------------------|------------------------------------------------------------------------------------------------|-------------------------|
| обязательные аттрибуты            |                                                                                                |                         |
| индекс                            | маркер строк для извлечения                                                                    | текст / число           |
| индекс иерария                    | номер уровня иерархии                                                                          | целочисленное число     |
| ркц описание                      | значение иерархии, если используем другое название не забываем изменить имя на листе параметры | текст                   |
| [пользовательские имена столбцов] | другие имена столбцов, которые задал пользователь во 2 строчке шапки                           |                         |
|                                   |                                                                                                |                         |
| зарезервированные имена           |                                                                                                |                         |
| ркц ур0, ркц ур1 ... ркц ур10     | зарезервировано для уровней иерархии                                                           | текст                   |
| имя файла                         | зарезервировано для имени файла                                                                | текст                   |


### Аттрибуты базы

| аттрибут                          | описание                  | тип данных              |
|-----------------------------------|---------------------------|-------------------------|
| индекс                            |                           | text / number           |
| индекс иерария                    |                           | integer (целочисленное) |
| ркц описание                      |                           | text                    |
| ркц ур0, ркц ур1 ... ркц ур10     | раскрытые уровни иерархии | text                    |
| время обновления база             | время обновления базы     | datetime                |
| имя файла                         | имя файла                 | text                    |
| [пользовательские имена столбцов] |                           |                         |

*порядок столбцов задаем на листе "Расположение столбцов"*

## Основные операции Power Query

1. загружаем пользовательские данные
    1. путь к журналам
    2. взаимное расположение столбцов в таблицах: контракт, факт
    3. параметры
2. извлекаем содержимое файлов с журналами
    1. нормализуем метаданные: имя листа и файла
    2. оставляем файлы с расширением: xlsx, xlsm
    3. оставляем заданные пользователем листы. Значение листа задается в параметре PrSheetName на листе параметры
3. трансформируем содержимое листов
    1. преобразовываем многострочную шапку документа
        1. нормализуем и объединяем строки шапки
        2. удаляем столбцы для которых не задана шапка
    2. добавляем аттрибут с именем файла
    3. заменяем пользовательские ошибки в журнале на null
    4. раскрываем иерархию
    5. исключаем строки у которых не задан индекс
    6. проверяем отсутсвие ошибок при трансформации файлов
        - ошибки при извлечении шапки
4. объединяем данные для формирования таблиц: контракт факт по отдельности
    1. контракт
        1. исключаем таблицы с ошибками при трансформации
        2. объединяем таблицы
        3. оставляем и переименовываем контрактные столбцы
            1. столбцы с маркером "контракт" - 1 строчка шапки
            2. столбцы иерархии "ркц ур 0..10" - создаются автоматически при извлечении иерархии
            3. "имя файла" - создается автоматически из имени файла
        5. добавляем время обновления
        6. меняем порядок согласно пользовательскому списку
    2. факт
        1. исключаем таблицы с ошибками при трансформации
        2. объединяем таблицы
        3. оставляем и переименовываем столбцы с фактом
            1. столбцы с маркером "факт" - 1 строчка шапки
            2. столбцы с маркером "контракт" - 1 строчка шапки , но без маркера "факт исключить" - 3 строчка шапки
            3. столбцы иерархии "ркц ур 0..10" - создаются автоматически при извлечении иерархии
            4. "имя файла" - создается автоматически из имени файла
        4. трансформируем столбцы с периодами в строки (unpivot)
            1. переносим столбцы с датами в строки (unpivot)
            2. исключаем строки без значений за период
            3. переносим аттрибуты периода: часы, объем, стоимость и тд., в столбцы (pivot), для повторяющихся строк суммируем значения
            4. удаление идентификатора для столбцов с одинаковыми названиями
        5. добавляем время обновления
        6. меняем порядок согласно пользовательскому списку

## Проверка работоспособности запроса

- запрос не падает при наличии ошибок в файле
- иерархия корректно раскрылась
- строки без индекса не попали в базу
- файлы с неверным расширением, неверным именем листа и ошибками при трансформации в базу не попадают
    - файлы с ошибками выводятся в отдельную таблицу
- шапка корректно нормализовалась, лишние столбцы удалены
    - в обоих таблицах присутствуют столбцы с уровнями иерархии
    - в обоих таблицах есть имя файла и время обновления
    - столбцы с маркером "факт исключить" (3 строка шапки) должны быть в таблице "контракт", но отсутствовать в таблице "факт"  
- для факта unpivot выполнился корректно
    - в таблице "факт" отсутствуют индексы без объемов
    - проверяем контрольные суммы
    - при дубликатах строк появляется сообщение с ошибкой
- расположение столбцов соответствует листу "настройка столбцов"

## Метрики отчета

## Является источником для
- отчет Power BI

## Требование к ПО
- Microsoft Excel 2019 и выше