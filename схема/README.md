# Определение сделанного (DoD)

Аналитику доступен инструмент загружающий локально справочники из google sheets:
- созданы ключи
- выполнена проверка уникальности ключа
- для справочника типовых позиций раскрыта иерархия с ведущими позициями
- для справочника типовых и ключевых добавлены поля для срезов PowerPivot

Аналитику доступен инструмент для генерации календаря.

## Решение

Для решения задачи по извлечению данных используем инструмент Power Query от Microsoft.

## Источники

- справочник: https://docs.google.com/spreadsheets/d/1zX687zRqVMG6ysqGuWN5EgDP--6BJJe1EKbNzNtGEjc/edit#gid=1131641557

## Требования для загрузки

## Структура листов инструмента

## Аттрибуты источника

### Ключевые

| аттрибут                       | описание                                 | тип данных |
|--------------------------------|------------------------------------------|------------|
| ключевые наименование          | описание ключевой позиции                | текст      |
| ед изм                         | единица измерения ключевой позиции       | текст      |
| ключевые наименование с ед изм | код ключевой позиции                     | текст      |
| ключевые уровень               | номер уровня ключевой позиции            | число      |
| ключевые вед поз               | маркер ведущей позиции                   | текст      |
| типовые_key                    | ключ типовой позиции                     | текст      |
| типовые вед поз                | маркер рассчета объема для типового кода | текст      |

### Типовые

| аттрибут             | описание                                            | тип данных |
|----------------------|-----------------------------------------------------|------------|
| типовые наименование | описание типового кода                              | текст      |
| ед изм               | единица измерения типовой позиции                   | текст      |
| типовые              | код типовой позиции по Белграду                     | текст      |
| типовые_key          | код типовой позиции для кодированя                  | текст      |
| типовые вед поз      | маркер ведущей позиции                              | текст      |
| типовые уровень      | номер уровня типовой позиции                        | число      |
| типовые вид работ    | группа типового кода; СМР / дополнительные часы     | текст      |
| добавлено гувр       | маркер который показывает, что код добавлен ГУВР'ом | текст      |

### Проект

| аттрибут       | описание                                                  | тип данных |
|----------------|-----------------------------------------------------------|------------|
| проект         | наименование проекта, часть ключа [проект]_[подпроект]    | текст      |
| проект краткий | краткое наименование проекта для PowerBI                  | текст      |
| подпроект      | наименование подпроекта, часть ключа [проект]_[подпроект] | текст      |

### Организация

| аттрибут               | описание                                                                         | тип данных |
|------------------------|----------------------------------------------------------------------------------|------------|
| организация            | наименование организации, ключ                                                   | текст      |
| организация без суб вм | наименование организации в которой субподрдчики ВМ считаются как ВМ              | текст      |
| организация с суб вм   | наименование организации, в которой субподрядчики ВМ выделены в отдельную группу | текст      |
| источник               | источник наименования организации                                                | текст      |

### Техника

| аттрибут             | описание                                   | тип данных |
|----------------------|--------------------------------------------|------------|
| наименование техники | наименование техники для ключа             | текст      |
| подгруппа техники    | укрупннное наименование техники для отчета | текст      |
| группа техники       | укрупннное наименование техники для отчета | текст      |

### Классификатор

| аттрибут               | описание                     | тип данных |
|------------------------|------------------------------|------------|
| классификатор          | код классификатора для ключа | текст      |
| классификатор описание | описание кода классификатора | текст      |


## Аттрибуты базы

## Основные операции Power Query
. получаем путь к справочнику в google sheets
. загружаем справочники: проект, организация, классификатор, техника
    . извлекаем данные из соответствующего листа
    . используем первую строку листа в качестве заголовка 
    . выбираем необходимые столбцы
    . изменяем тип данных
        . для проекта заполняем отсутствующие наименования проекта из заголовков
    . удаляем пустые строки
    . дублируем поля для формирования ключа
    . нормализуем значения для ключа
        . для проекта объединяем значения в композитный ключ
    . проверяем уникальность ключа
    . добавляем сортировку
    . добавляем время обновления
. создаем календарь согласно заданным параметрам
. создаем справочник ключевых
    . загружаем источник
        . извлекаем данные из соответствующего листа
        . используем первую строку листа в качестве заголовка 
        . заменяем отсутствующие значения для tickbox на null
        . удаляем строки без значений
    . раскрываем иерархию
        . оставляем требуемые столбцы
        . убираем ведущие пробелы в столбцах с иерархией
        . раскрываем иерархию
            . добавляем столбцы с иерархие по ее номеру
            . заполняем иерархию значениями сверху-вниз
        . добавляем путь иерархии
    . создаем ведущие позиции
        . оставляем столбцы с путем, ключом и номером иерархии
        . трансформируем путь в список ключей
        . раскрываем список ключей в строки
        . self join для получения ведущей позиции
        . группируем по ключу
        . находим текущий уровень и определяем ведущую позицию (она всегда будет ведущей)
        . определяем ведущие позиции для остальных уровней
        . раскрываем записи с ведущими позициями
    . объединяем таблицы с иерархией и ведущими позициями
    . получаем результирующую таблицу ключевых
        . создаем композитный ключ из наименования и ед изм
        . проверяем уникальность ключа
        . добавляем столбцы с сортировкой
        . добавляем срезы
        . добавляем глубину уровня
        . добавляем время обновления
        . изменем расположение столбцов
. создаем справочник типовых
    . загружаем источник
        . извлекаем данные из соответствующего листа
        . используем первую строку листа в качестве заголовка 
        . заменяем отсутствующие значения для tickbox на null
        . удаляем строки без значений
    . раскрываем иерархию
        . оставляем требуемые столбцы
        . убираем ведущие пробелы в столбцах с иерархией
        . раскрываем иерархию
            . добавляем столбцы с иерархией по ее номеру
                . на основании добавленных столбцов создаем объединенные столбцы с ед и кодом
            . заполняем иерархию значениями сверху-вниз
        . добавляем путь иерархии


## Проверка работоспособности запроса

## Является источником для

- база дополнительных часов
- база велесстрой-монтажа
- база ет1
- база ключевых показателей
- отчет PBI

## Требование к ПО
- Microsoft Excel 2019 и выше