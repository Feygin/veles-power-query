# Описание

## Определение сделанного (DoD)

Аналитику доступен инструмент при помощи которого он из базы журналов формирует базу Велесстрой-Монтажа:
- реализован механизм исключения строк с промежуточными итогами 
- реализован рассчет нормочасов с и без зимнего к-та
- реализовано извлечения метаданных из имени файла
    - проект, подпроект, организация
- реализована нормализация ключей для справочника
    - проект, подпроект, организация
- реализовано обогащение данных журнала данными из справочника
    - объединение данных не чувствительно к регистру
- реализован механизм кодировки типовых позиций журнала вне журнала
- реализован механизм определения новых и удаленных позиций для кодирования

Для проверки качества извлечения реализовано:
- реализован механизм показывающий ошибки при извлечении данных (неверная трансформация типа данных)
- реализована проверка дубликатов индекса в журнале
- реализована проверка дубликатов индекса в кодировке
    - для исключения случаев завышения фактических показателей при join 
- реализован инструмент сравнивающий накопительные и фактические показатели
    - объемы, часы

Написана пользовательская инструкция

## Решение

Для решения задачи по извлечению данных используем инструмент Power Query от Microsoft.

## Механика работы с базой

### Как исключить из базы строки

Не все строки из базы журналов должны попасть в базу Велесстрой-Монтажа. Часть строк относится к заголовкам или промежуточным итогам. Если их включить в базу возможно искусственное увеличение позателей и образование ненужных строк в кодировке. Мы исключаем строки от противного, а именно в столбце "индекс включить" задаем строки , которые *попадут* в базу Велесстрой-Монтажа. Столбец "индекс включить" задается аналогично столбцу "индекс" при формировании базы журналов. Чтобы включить строку достаточно ввести любой символ, например "v".

### Как извлекается имя организации, проекта и подпроекта из имени файла

Имя журнала Велесстрой-Монтажа должно соответствовать шаблону ЖУРНАЛ-[# ЖУРНАЛА]_[ОРГАНИЗАЦИЯ]_[ПРОЕКТ]_[ПОДПРОЕКТ]_[ДИСЦИПЛИНА]_[ДОП ПОЛЕ]_[ДАТА].[xlsx|xlsm], где:
- [# ЖУРНАЛА] - уникальный номер журнала, является частью составного ключа для определения позиции кодировки
- [ОРГАНИЗАЦИЯ] - организация выполняющая работы
- [ПРОЕКТ] - название проекта
- [ПОДПРОЕКТ] - название подпроекта
- [ДИСЦИПЛИНА] - название дисциплины
- [ДОП ПОЛЕ] - дополнительное пользовательское поле
- [ДАТА] - отчетная дата выполнения работ

Запрос извлекает имя организации, проекта и подпроекта из шаблона и добавлет значения в соответствующие столбцы базы. Пользователь может изменить поведение запроса если он собственоручно добавит в журнал соответвующие поля. Добавленные пользователем столбцы имеют приоритет над значениями из имени файла. Например, в одном журнале подрядчик может отчитываться по нескольким подпроектам. Чтобы не разделять журнал на несколько журналов, пользователь может добавить в него столбец в котором задаст имена подпроектов. Имена подпроектов необходимо задать для всех строк журнала. 

### Как данные объединяются со схемой (справочников)

Обогащение таблиц данными из схемы (справочников проекта, организации и тд) выполняется путем поиска совпадений по ключам. Столбцы с ключами помечены суффиксом "_key", например, "организация_key". Единственное исключение - столбец "дата" у которого отсутвует суффикс "key", но он является ключом для справочника "календарь". 

При формировании ключа, данные нормализуются: удаляются ведущие пробелы, непечатаемые символы и применяется нижний регистр. Ключи формируются из одноименных столбцов, например, для ключа "организация_key" берутся значения столбца "организация". Бывает, что ключ получается путем объединения значений двух столбцов, например, "проект" и "подпроект" для ключа "проект_key". Формулу для генерации ключа можно посмотреть в разделе "Аттрибуты базы". 

Далее значение ключа ищется в справочнике и при совпадении из него подтягивается информация. Если информация не подтянулась значит ключ не был найден в справочнике. В этом случае необходимо исправить данные источника, добавить новые позиции в справочник или заменить ключ при выполнении запроса. С первыми двумя опциями все очевидно, рассмотрим подробней замену ключей при выполнении запроса. Для этого воспользуемся таблицей замены на листе "нормализация знаений". В ней из предустановленного списка задаем имя столбца источника ("имя столбца") в котором ищем значение ключа ("значение исходное") и заменяем на результирующие значение ("значение результат"). 

### Как выполняется кодировка строк журнала типовыми позициями

Для кодировки строк журнала типовыми позициями нам нужен уникальный идентификатор строки и описание выполненной работы. В качестве уникального идентификатора используется комбинация номера журнала и индекса журнала, а выполненную работу мы типизируем, опираясь на описание, иерархию (см. инструкцию к базе журналов), единицу измерения и норму. 

#### Добавленные строки

После того как мы проиндексировали журналы нам нужно определить строки журнала для кодирования. Эти строки автоматически подгружаются на лист "Кодировка новые". Они определяются путем сравнения идентификаторов на листе кодировка с идентификаторами на листе "Контракт". Если какой-то идентификатор есть на листе "Контракт", но отсутствует на листе "Кодировка" он появится на листе "Кодировка новые." Позиции без накопительных часов или объемов в кодировку не попадают. Это сделано для того чтобы не тратить время на кодировку позиций по которым еще не начаты работы. Далее необходимо скопировать данные в таблицу "Кодировка". 

Для кодировки мы пользуемся кодами из справочника "типовых". Код в формате "[код типовой позиции]_[ед изм]" заносится в столбец типовые. Если для этого кода считаем объем, тогда дополнительно заполняем столбец "типовые вед поз". В него можно поставить любой символ, например, "v" или продублировать значение кода.

#### Удаленные строки

Бывает, что из журнала удаляют строки. В этом случае необходимо удалить из таблицы "кодировка" соответвующие строки. Если их не удалить есть риск того, что при доиндексировании журнала мы используем индексы из листа для кодировки, но уже для других работ. Это приведет к ошибочным рассчетам показателей. Идентификаторы удаленных строк выгружаются на лист "кодировка удаленные". По ним мы находим соответствующие идентификаторы на листе кодировка и удаляем эти строки. 

#### Дубликаты индекса

Формирование иерархии и индексация выполняется на этапе формирования базы журналов. Существует два сценария индексации журнала: индексация нового журнала и доиндексация ранее проиндексированного журнала. Во втором случае индексы добавляются для новых строк журнала. Если подрядчик нарушил правила ведения журнала в нем могут появиться дубликаты индекса, а это в свою очередь может привести к ошибкам при рассчете показателей. Их можно посмотреть на листе "дубликаты индекса". Если обнаружены дубликаты необходимо эти индексы удалить из журнала и из таблицы кодировка. После этого можно доиндексировать журнал.

Далее приводим алгоритм эффективный алгоритм индексации и кодировки журнала:
1. без индексации загружаем журналы в базу журналов
2. проверяем журналы на дубликаты индекса
    - если обнаружили дубликаты, удаляем их из журнала и из одировки
3. доиндексируем журналы и заного загружаем в базу журналов
4. удаляем из кодировки удаленные из журнала строки
5. добавляем в кодировку доиндексированные строки
6. кодируем типовыми позициями
7. обновляем базу, чтобы подгрузились новые коды

### Как рассчитываются нормочасы

Формула рассчета приведена в разделе "Аттрибуты базы" этой инструкции

### Как проверить качество данных

#### Проверяем наличие ошибок при извлечении данных

При формировании базы могут появиться ошибки. Например, неверное преобразование типа данных. Эти ошибки не прекращают работу запроса, но таким образом можно потерять часть данных. Такие ошибки выгружаются на лист "Ошибки трансформации" 

#### Проверяем накопитель и сумму за месяцы

При правильном заполнении журнала и извлечении данных сумма часов и объемов в накопительной части сходится с суммой всех часов и объемов за все периоды строительство. Эта сумма может не сходиться в трех случаях:
1. в журнале допущена ошибка в формуле суммирования
2. в журнале в формулу суммирования добавлены численные значения без ссылки на ячейку
3. при извлечении специалист задал шапку не для всех периодов строительства

На листе "проверка накопителя" можно сверить значения накопителя и ежемесячных данных. 

## Источники

- файл с базой журналов
- файл схемы

## Требования для загрузки

- путь к файлам формата: C:\Users\FeyginAS\база журналов.xlsx
- собрана база журналов с учетом специфики Велесстрой-Монтажа
    - имена столбцов согласно спецификации
- задан зимний коэффициент для всех месяцев
- заданы строки, которые должны попасть в базу в столбце "индекс включить"

## Структура листов инструмента

### Перед первым запуском

Инструкция по отключению конфиденциальности

### Параметры

Задаем пути к схеме и базе журналов

### Нормализация значений

Задаем наименования проекта, подпроекта и организации, которые необходимо переименовать под требования схемы (справочника)

### Зимний к-т

Задаем значения зимнего коэффициента для каждого месяца выполнения работ

### Ошибки трансформации

Выявленные ошибки при трансформации журналов. Обычно - это изменение типа данных.

### Дубликаты индекса

Список дубликатов индекса в журналах

### Проверка накопителя

Построчная проверка суммы часов и объемов между блоками с накопительными данными и ежемесячной информацией.

### Кодировка новые

Новые позиции в журнале. Позиция считается новой если для журнала индекс из таблицы контракт отсутвует в таблице кодировка.

### Кодировка удаленные

Удаленные из журнала позиции. Позиция считается удаленной если для журнала индекс из таблицы кодировка отсутвует в таблице контракт.

### Кодировка

Здесь присваеваем проиндексированным строчкам номера типовых кодов. Позиции для кодирования копируем из листа "Кодировка новые"

### Контракт

Собранная таблица контракт

### Факт

Собранная таблица факт

## Аттрибуты источника

### Таблица контракт

| аттрибут                  | описание                                                                     | тип данных         |
|---------------------------|------------------------------------------------------------------------------|--------------------|
| индекс                    | индекс строки журнала                                                        | число / текст      |
| индекс иерархия           | уровень иерархии строки журнала                                              | целочисленное чило |
| индекс включить           | условие включения строки в базу вм; любой символ или текст                   | текст              |
| проект                    | название проекта из источника; если отсутствует извлекаем из имени файла     | текст              |
| подпроект                 | название подпроекта из источника; если отсутствует извлекаем из имени файла  | текст              |
| организация               | название организации из источника; если отсутствует извлекаем из имени файла | текст              |
| ркц поз                   | номер позиции ркц                                                            | текст              |
| ркц ур1                   | наименование первого уровня ркц по иерархии                                  | текст              |
| ркц ур2                   | наименование второго уровня ркц по иерархии                                  | текст              |
| ркц ур3                   | ...                                                                          | текст              |
| ркц ур4                   | ...                                                                          | текст              |
| ркц ур5                   | ...                                                                          | текст              |
| ркц ур6                   | ...                                                                          | текст              |
| ркц ур7                   | ...                                                                          | текст              |
| ркц ур8                   | ...                                                                          | текст              |
| ркц ур9                   | ...                                                                          | текст              |
| ркц ур10                  | наименование десятого уровня ркц по иерархии                                 | текст              |
| ркц описание              | описание позиции ркц                                                         | текст              |
| ед изм                    | единица измерения выполняемой работы                                         | текст              |
| норма                     | норма для работы, [чел. час. / единица объема]                               | число              |
| объем контракт            | объем работ по контракту                                                     | число              |
| объем накопительно        | выполненный объем работ с начала строительства                               | число              |
| часы накопительно         | затраченные человеческие ресурсы с начала строительства                      | число              |
| часы техника накопительно | затраченные механические ресурсы с начала строительства                      | число              |
| имя файла                 | имя файла журнала из которого извлечены данные                               | текст              |
| время обновления журнала  | дата и время извлечения данных из журнала                                    | текст              |

### Таблица факт

| аттрибут                  | описание                                                                     | тип данных         |
|---------------------------|------------------------------------------------------------------------------|--------------------|
| индекс                    | индекс строки журнала                                                        | число / текст      |
| индекс иерархия           | уровень иерархии строки журнала                                              | целочисленное чило |
| индекс включить           | условие включения строки в базу вм; любой символ или текст                   | текст              |
| дата                      | дата выполнения работы по журналу; блок факт                                 | дата               |
| проект                    | название проекта из источника; если отсутствует извлекаем из имени файла     | текст              |
| подпроект                 | название подпроекта из источника; если отсутствует извлекаем из имени файла  | текст              |
| организация               | название организации из источника; если отсутствует извлекаем из имени файла | текст              |
| ркц поз                   | номер позиции ркц                                                            | текст              |
| ркц ур1                   | наименование первого уровня ркц по иерархии                                  | текст              |
| ркц ур2                   | наименование второго уровня ркц по иерархии                                  | текст              |
| ркц ур3                   | ...                                                                          | текст              |
| ркц ур4                   | ...                                                                          | текст              |
| ркц ур5                   | ...                                                                          | текст              |
| ркц ур6                   | ...                                                                          | текст              |
| ркц ур7                   | ...                                                                          | текст              |
| ркц ур8                   | ...                                                                          | текст              |
| ркц ур9                   | ...                                                                          | текст              |
| ркц ур10                  | наименование десятого уровня ркц по иерархии                                 | текст              |
| ркц описание              | описание позиции ркц                                                         | текст              |
| ед изм                    | единица измерения выполняемой работы                                         | текст              |
| зимний коэф условие       | условие при котором рассчитывает зимний к-т; значения {null, "да"}           | текст              |
| идентификатор             | дополнительный идентификатор (см базу журналов)                              | текст              |
| норма                     | норма для работы, [чел. час. / единица объема]                               | число              |
| объем факт                | фактически выполненный объем работ за период                                 | число              |
| часы факт                 | фактически затраченные человеческие ресурсы за период                        | число              |
| часы техника факт         | фактически затраченные механические ресурсы за период                        | число              |
| имя файла                 | имя файла журнала из которого извлечены данные                               | текст              |
| время обновления журнала  | дата и время извлечения данных из журнала                                    | текст              |

## Аттрибуты базы

### Таблица контракт

| аттрибут                                        | описание                                                                                | источник           | формула вычисления                     | тип данных         |
|-------------------------------------------------|-----------------------------------------------------------------------------------------|--------------------|----------------------------------------|--------------------|
| журнал номер                                    | номер журнала, извлекается из имени журнала, образует уникальный ключ вместе с индексом | вычисление         |                                        | текст              |
| индекс                                          |                                                                                         | источник           |                                        | число / текст      |
| индекс иерархия                                 |                                                                                         | источник           |                                        | целочисленное чило |
| индекс включить                                 |                                                                                         | источник           |                                        | текст              |
| проект                                          |                                                                                         | источник           |                                        | текст              |
| подпроект                                       |                                                                                         | источник           |                                        | текст              |
| проект_key                                      | ключ проекта для объединения со схемой                                                  | вычисление         | lower(проект) & "_" & lower(подпроект) | текст              |
| схема.проект                                    | название проекта из схемы                                                               | схема, проект      |                                        | текст              |
| схема.подпроект                                 | название подпроекта из схемы                                                            | схема, подпроект   |                                        | текст              |
| организация                                     |                                                                                         | источник           |                                        | текст              |
| организация_key                                 | ключ организации для объединения со схемой                                              | вычисление         | lower(организация)                     | текст              |
| схема.организация                               | название организации из схемы                                                           | схема, организация |                                        | текст              |
| ркц поз                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур1                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур2                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур3                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур4                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур5                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур6                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур7                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур8                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур9                                         |                                                                                         | источник           |                                        | текст              |
| ркц ур10                                        |                                                                                         | источник           |                                        | текст              |
| ркц описание                                    |                                                                                         | источник           |                                        | текст              |
| ед изм                                          |                                                                                         | источник           |                                        | текст              |
| типовые                                         | типовая позиция из таблицы кодировка, ищется по ключу [журнал номер] & [индекс]         | база вм, кодировка |                                        | текст              |
| типовые вед поз                                 | ведущая позиция из таблицы кодировка, ищется по ключу [журнал номер] & [индекс]         | база вм, кодировка |                                        | текст              |
| схема.типовые наименование с ед изм и кодом     | наименование типовой позиции по которой кодировалась база с единицей измерения и кодом  | схема, типовые     |                                        | текст              |
| схема.типовые ур0 наименование с ед изм и кодом | наименование типовой позиции 0 уровня с единицей измерения и кодом                      | схема, типовые     |                                        | текст              |
| схема.типовые ур0 вед поз                       | условие для вычисления объема по 0 уровню типовой позиции                               | схема, типовые     |                                        | текст              |
| схема.типовые ур1 наименование с ед изм и кодом | ...                                                                                     | схема, типовые     |                                        | текст              |
| схема.типовые ур1 вед поз                       | ...                                                                                     | схема, типовые     |                                        | текст              |
| схема.типовые ур2 наименование с ед изм и кодом | ...                                                                                     | схема, типовые     |                                        | текст              |
| схема.типовые ур2 вед поз                       | ...                                                                                     | схема, типовые     |                                        | текст              |
| схема.типовые ур3 наименование с ед изм и кодом | ...                                                                                     | схема, типовые     |                                        | текст              |
| схема.типовые ур3 вед поз                       | ...                                                                                     | схема, типовые     |                                        | текст              |
| схема.типовые ур4 наименование с ед изм и кодом | ...                                                                                     | схема, типовые     |                                        | текст              |
| схема.типовые ур4 вед поз                       | ...                                                                                     | схема, типовые     |                                        | текст              |
| норма                                           |                                                                                         | источник           |                                        | число              |
| объем контракт                                  |                                                                                         | источник           |                                        | число              |
| нормочасы контракт                              |                                                                                         | вычисление         | [объем контракт] * [норма]             | число              |
| объем накопительно                              |                                                                                         | источник           |                                        | число              |
| часы накопительно                               |                                                                                         | источник           |                                        | число              |
| часы техника накопительно                       |                                                                                         | источник           |                                        | число              |
| имя файла                                       |                                                                                         | источник           |                                        | текст              |
| время обновления журнала                        |                                                                                         | источник           |                                        | дата               |
| время обновления база                           |                                                                                         | вычисление         |                                        | дата               |

### Таблица факт (результат)

| аттрибут                                        | описание                                                                                | источник                    | формула вычисления                    | тип данных         |
|-------------------------------------------------|-----------------------------------------------------------------------------------------|-----------------------------|---------------------------------------|--------------------|
| журнал номер                                    | номер журнала, извлекается из имени журнала, образует уникальный ключ вместе с индексом | вычисление                  |                                       | текст              |
| индекс                                          |                                                                                         | источник                    |                                       | число / текст      |
| индекс иерархия                                 |                                                                                         | источник                    |                                       | целочисленное чило |
| индекс включить                                 |                                                                                         | источник                    |                                       | текст              |
| дата                                            |                                                                                         | источник                    |                                       | дата               |
| схема.месяц год                                 | год и месяц выполнения работы                                                           | схема, календарь            |                                       | текст              |
| проект                                          |                                                                                         | источник                    |                                       | текст              |
| подпроект                                       |                                                                                         | источник                    |                                       | текст              |
| проект_key                                      | ключ проекта для объединения со схемой                                                  | вычисление                  | lower(проект) & "_" & lower(подпроект)| текст              |
| схема.проект                                    | название проекта из схемы                                                               | схема, проект               |                                       | текст              |
| схема.подпроект                                 | название подпроекта из схемы                                                            | схема, подпроект            |                                       | текст              |
| организация                                     |                                                                                         | источник                    |                                       | текст              |
| организация_key                                 | ключ организации для объединения со схемой                                              | вычисление                  | lower(организация)                    | текст              |
| схема.организация                               | название организации из схемы                                                           | схема, организация          |                                       | текст              |
| ркц поз                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур1                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур2                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур3                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур4                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур5                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур6                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур7                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур8                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур9                                         |                                                                                         | источник                    |                                       | текст              |
| ркц ур10                                        |                                                                                         | источник                    |                                       | текст              |
| ркц описание                                    |                                                                                         | источник                    |                                       | текст              |
| ед изм                                          |                                                                                         | источник                    |                                       | текст              |
| типовые                                         | типовая позиция из таблицы кодировка, ищется по ключу [журнал номер] & [индекс]         | база вм, кодировка          |                                       | текст              |
| типовые вед поз                                 | ведущая позиция из таблицы кодировка, ищется по ключу [журнал номер] & [индекс]         | база вм, кодировка          |                                       | текст              |
| схема.типовые наименование с ед изм и кодом     | наименование типовой позиции по которой кодировалась база с единицей измерения и кодом  | схема, типовые              |                                       | текст              |
| схема.типовые ур0 наименование с ед изм и кодом | наименование типовой позиции 0 уровня с единицей измерения и кодом                      | схема, типовые              |                                       | текст              |
| схема.типовые ур0 вед поз                       | условие для вычисления объема по 0 уровню типовой позиции                               | схема, типовые              |                                       | текст              |
| схема.типовые ур1 наименование с ед изм и кодом | ...                                                                                     | схема, типовые              |                                       | текст              |
| схема.типовые ур1 вед поз                       | ...                                                                                     | схема, типовые              |                                       | текст              |
| схема.типовые ур2 наименование с ед изм и кодом | ...                                                                                     | схема, типовые              |                                       | текст              |
| схема.типовые ур2 вед поз                       | ...                                                                                     | схема, типовые              |                                       | текст              |
| схема.типовые ур3 наименование с ед изм и кодом | ...                                                                                     | схема, типовые              |                                       | текст              |
| схема.типовые ур3 вед поз                       | ...                                                                                     | схема, типовые              |                                       | текст              |
| схема.типовые ур4 наименование с ед изм и кодом | ...                                                                                     | схема, типовые              |                                       | текст              |
| схема.типовые ур4 вед поз                       | ...                                                                                     | схема, типовые              |                                       | текст              |
| зимний коэф условие                             |                                                                                         | источник                    |                                       | текст              |
| зимний коэф                                     | зимний коэффициент, ищется по таблице зимнего коэффициента для отчетной даты            | база вм, зимний коэффициент |                                       | число              |
| идентификатор                                   |                                                                                         | источник                    |                                       | текст              |
| норма                                           |                                                                                         | источник                    |                                       | число              |
| объем факт                                      |                                                                                         | источник                    |                                       | число              |
| нормочасы факт                                  | нормочасы для фактически выполненного объема                                            | вычисление                  | [норма] * [объем факт]                | число              |
| нормочасы зимний факт                           | нормочасы для фактически выполненного объема с учетом зимнего коэффициента              | вычисление                  | *1                                    | число              |
| часы факт                                       |                                                                                         | источник                    |                                       | число              |
| часы техника факт                               |                                                                                         | источник                    |                                       | число              |
| имя файла                                       |                                                                                         | источник                    |                                       | текст              |
| время обновления журнала                        |                                                                                         | источник                    |                                       | дата               |
| время обновления база                           |                                                                                         | вычисление                  |                                       | дата               |

*1 [нормочасы факт]  * (if [зимний коэф условие] <> null and [зимний коэф] <> null then [зимний коэф] else 1

## Основные операции Power Query

1. загружаем пользовательские данные
    1. путь к базе журналов
    2. путь к схеме
    3. таблицу с зимним коэффициентом
        1. загружаем таблицу
        2. изменяем тип данных
        3. заменяем ошибки в файле
        4. удаляем строки без заданных дат
        5. проверяем уникальность ключа
    4. кодировку
        1. заменяем ошибки в таблице
        2. удаляем строки без "журнал номер" и "индекса"
        3. оставляем требуемые столбцы и изменяем тип данных
        4. нормализуем данные
        5. проверяем уникальность ключа "индекс" и "журнал номер"
    5. списки с заменой проекта, подпроекта, организации
        1. загружаем таблицу с переименованием
        2. исключаем строки без значений
        3. нормализуем данные
        4. удаляем дубликаты
        5. преобразовываем в списки для переименования
            - проект
            - подпроект
            - организация
2. формируем таблицу контракт и факт
    1. контракт / факт
        1. извлекаем таблицу из базы журналов
        2. проверяем наличие таблицы в файле
        3. выбираем требуемые аттрибуты, для отсутствующих используем null
        4. извлекаем метаданные из имени файла
        5. объединяем извлеченные метаданные с аттрибутами таблицы (coalesce)
        6. оставляем отмеченные в аттрибуте "индекс включить" строки
        7. заменяем "." на "," в столбцах с числами
        8. изменяем тип данных аттрибутов
        9. нормализуем ключи
        10. заменяем наименования проекта, подпроекта, организации согласно пользовательскому списку
        11. присоединяем кодировку по ключу "журнал номер", "индекс"
        12. присоединяем справочники схемы
            - для факта присоединяем календарь, зимний к-т
        13. вычисляем нормочасы
            - для контракта: нормочасы по контракт
            - для факта: нормочасы факт, нормочасы факт зимний
        14. добавляем аттрибут со времен обновления базы
        15. задаем расположение столбцов
3. фломируем таблицы с кодировкой
    1. новые позиции для кодирования
        1. выбираем необходимы аттрибуты в сформированной таблице контракт
        2. заменяем ошибки на null (чтобы не упал запрос при join)
        3. оставляем строки с отличными от 0, null накопительными часами или объемами
        4. оставляем такие строки, которые есть в контракте, но отсутствуют в кодировке
            - сравнение ведется по ключу номер журнала & инжекс (left anti join)
        5. добавляем аттрибуты типовые, типовые вед поз 
            - для соответствия с таблицей кодировка
    2. позиции, которые были удалены из журнала
        1. из таблицы "контракт" получаем список загруженных журналов
        2. оставляем в таблице "кодировка" загруженные журналы
            - чтобы не удалить кодировку для журналов не загруженныв в текущую версию базы
        3. находим строки кодировки которые отсутствуют в "контракте"
            - сравнение ведется по ключу номер журнала & инжекс (left anti join)
4. формируем таблицы с проверкой данных
    1. таблица с дубликатами индекса в журналах
        - группируем таблицу контракт по имени журнала и индекса
        - оставляем строки у которых повторяется индекс
    2. таблица с ошибками при трансформации
        - находим ошибки в таблицах факт, контракт
        - объединяем результат
    3. таблица с несоответствиями накопительной и фактической части журнала
        1. для каждой строки журнала считаем итоговые значения часов и объемов
        2. объединяем данные контракта и факта
        3. считаем абсолютные и относительные дельты
            - объемы
            - часы

## Проверка работоспособности запроса
1. загрузка данных
    1. таблица с зимним к-том
        - неверный формат дат и зимнего к-та не ломает запрос
        - из таблицы удалены строки без дат
        - дубликаты дат выдают ошибку
    2. таблица кодировки
        - ошибки в таблице не кладут запрос
        - строки без номера журнала и индекса исключены
        - номер журнала, индекса, типовая позиция нормализована
        - дубликаты ключа (номер журнала и индекс) выдают ошибку
    3. таблица нормализации проекта, подпроекта, организации
        - удалены строки без значений
        - значения нормализованы
        - удалены дубликаты
2. контракт / факт
    1. при отсутствии таблицы выдается ошибка
    2. загружены все аттрибуты согласно спецификации в заданном порядке
    3. извлечены метаданные из имени журнала
        - проект, подпроект, организация, имя файла
        - выполнился coalesce с аттрибутами источника
    4. строки без маркера "индекс включить" исключены
    5. в столбце с числами заменены "." на ","
    6. сгенерированы и нормализованы ключи
        - проект, организация
    7. заменены значения аттрибутов проект, подпроект, организация согласно польз. списку
    8. присоединена кодировка, схема, зимний (для факта)
    9. рассчитаны нормочасы, для факта еще с зимним
        - нет условия, есть к-т -> нормочасы
        - нет условия, нет к-т -> нормочасы
        - есть условие, есть к-т -> нормочасы * к-т
        - есть условие, нет к-т -> нормочасы
3. кодировка
    1. новые позиции
        - ошибки в таблицах контракт / факт не кладут запрос
        - строки без накопительных объемов или часов не попадают в результат
        - остаются строки присутствующие в контракте, но отсутствующие в факте
        - аттрибуты расположены согласно спецификации
    2. удаленные позиции
        - поиск производится только по загруженным журналам
        - выводятся строки кодировки, которые есть в кодировке, но отсутствуют в контракте
4. проверка ошибок
    1. дубликаты индекса
        - выводятся дубликаты индекса в журнале
    2. проверка ошибок в журнале
        - выводятся ошибки при трансформации данных
    3. несоответствие накопительной и фактической части
        - корректно считается абсолютная и фактическая разница в часах
            - для 0,0 - 0
            - для 0, 1 +100 %
            - для 1, 0 -100%

## Метрики отчета

## Является источником для
- отчет Power BI

## Требование к ПО
- Microsoft Excel 2019 и выше