# Описание

## Описание проблемы

Для каждого проекта аналитик отдела мониторинга ежедневно собирает ключевые показатели: 
- ключевые объемы
- людские ресурсы по видам работ (ЛР по видам работ)
- технические ресурсы (Тех.Ресурсы)
В качестве источников он использует отчеты субподрядных организаций. Источники не структированы, поэтому данные обрабатываются вручную. В конце месяца он их сводит и переносит в накопительные таблицы с соответствующими именами. Накопители представляют собой формат сводных таблиц, где в строках хранятся аттрибуты работы: названия ключевых показателей, организаций, единиц техники и тд., а в столбцах: месяцы выполнения работ. На пересечение строк и столбцов заносятся ключевые показатели: объемы работ, трудовые и технические ресурсы. Помимо этого в таблицах вычисляются промежуточные итоги по строкам и столбцам.

После того как данные сведены, аналитик формирует отчеты для компании:
1. проверка качества данных
2. сводный отчет по проекту
3. сводный отчет по всем проектам

Для проверки качества данных аналитик сверяет ключевые показатели с данными отчетов ЕТ1. Отчеты ет1 предоставляет группа учета выполненных работ. Сверка ведется по объемам работ и затраченным трудовым ресурсам. Чтобы сравнить данные их необходимо предварительно свести по единым справочникам: проект, организация, типовые позиции. Процесс сведения затруднен по следующим причинам:
- справочники хранятся отдельно
- справочники регулярно обновляются 
- опечатки в исчтониках: неверный регистр, лишние пробелы и тд.

Для сводного отчета по проекту необходимо собрать в одну таблицу значения выполненных объемов работ и затраченных трудовых ресурсов. Аналитику должен иметь возможность оперативно посмотреть данные за весь период строительства, за 2 предыдущих месяца в разрезе подпроектов и организаций. Также аналитик рассчитывет фактический норматив = затраченным трудовым ресурсам / объем выполненной работы. Существующий формат не позволяет оперативно получить такой отчет.  

Для получения единого отчета по всем проектам необходимо:
1. актуализировать информаию во всех сводных отчетах по проекту
2. свести отчеты в единый файл
3. при изменении данных в источнике - повторить операцию

## Определение сделанного (DoD)

Аналитику доступен инструмент при помощи которого он собирает ключевые показатели по проектам в единый файл: 
- даты перенесены из столбцов в строки
- промежуточные итоги по строкам и столбцам изключены
- данные обогащены значениями из справочника

Для проверки качества извлечения:
- реализована проверка полноты извлечения
- реализована проверка отсутсвия потери данных при извлечении

Написана пользовательская инструкция. 

## Особенности источника
Для каждого отчета создан шаблон для заполнения. Но от проекта к проекту он может отличаться:
- отличается количество периодов 
- в шаблон могут быть добавлены дополнительные столбцы с расчетами
- начало шапки строго не зафиксировано
- для наименования работ, организиций и ед изм могут применяться объединенные ячейки
- шапка состоит из объединенных ячеек
- на одном листе может располагаться несколько накопительных таблиц, например, по подпроектам

## Решение

Для решения задачи используем инструмент Power Query от Microsoft. С его помощью извлекаем данные из сводной двумерной таблицы и преобразовываем в длинный одномерный формат, объеденияем данные проектов в единую таблицу и обогащаем их информацией из справочников. 

В исходниках рассчитываются промежуточные итоги в столбцах, начало шапки строго не зафиксировано и количество столбцов может варьироваться, поэтому пользователю необходимо вручную задать в первой строке листа названия столбцов и периодов. Названия берутся из раздела "Аттрибуты источника". 

Также необходимо исключить промежуточные итоги в строках и другую нерелевантную информацию. Для этого в столбце фильтр пользователь отмечает строки которые будут загружены в базу.  

## Источники

- папка с файлами баз ключевых часов за месяц, формата xlsx
- справочник(схема)

## Требования для загрузки

- допустимое название листов: "Ключевые объемы", "ЛР по видам работ", "Тех.Ресурсы"
- на листе как минимум должны быть данные для одной строки одного периода
- аттрибуты первой строки строго соответствуют таблицам из "Аттрибуты источника"
- периоды заданы в формате дата
- для таблиц: "ЛР по видам работ", "Тех.Ресурсы" значения единиц измерения строго соответсуют допустимым (см. "Аттрибуты источника")

## Структура листов инструмента

### Перед первым запуском

Инструкция по отключению конфиденциальности

### Параметры

Задаем путь к схеме и папке с ключевыми показателями

### Нормализация

Таблица для изменения названий организаций 

### Статус извлечения

Проверяем, что из всех файлов были извлечены таблицы

### Ошибки

Проверяем, отсутсвие ошибок при извлеченииданных. В основном появляются при изменении типа данных.

### Ключевые объемы

Объединенная таблица с ключевыми объемами и присоединенной схемой.

### Ключевые часы

Объединенная таблица с ключевыми часами и присоединенной схемой.

### Ключевые техника

Объединенная таблица с техникой и присоединенной схемой.

### Отчет ключевые

Сводный отчет по проектам с объемами, часами и нормой

### Отчет техника

Сводный отчет техники по проектам

## Аттрибуты источника

### Ключевые объемы

| аттрибут        | описание                                                | тип данных |
|-----------------|---------------------------------------------------------|------------|
| строки          |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| фильтр          | фильтр, который определяет какие строки попадут в базу  | текст      |
| проект          | проект по справочнику                                   | текст      |
| подпроект       | подпроект по справочнику                                | текст      |
| ключевые        | наименование ключевой позиции по справочнику            | текст      |
| организация     | организация (можно нормализовать)                       | текст      |
| ед изм          | единица измерения ключевой позици по справочнику        | текст      |
|-----------------|---------------------------------------------------------|------------|
| столбцы         |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| дата            | месяца производства работ                               | дата       |

### Ключевые часы (лр по видам работ)

| аттрибут        | описание                                                | тип данных |
|-----------------|---------------------------------------------------------|------------|
| строки          |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| фильтр          | фильтр, который определяет какие строки попадут в базу  | текст      |
| проект          | проект по справочнику                                   | текст      |
| подпроект       | подпроект по справочнику                                | текст      |
| ключевые        | наименование ключевой позиции по справочнику            | текст      |
| организация     | организация (можно нормализовать)                       | текст      |
| ключевые ед изм | единица измерения ключевой позици по справочнику        | текст      |
| ед изм          | единица измерения показателя (ч.ч, чел.)                | текст      |
|-----------------|---------------------------------------------------------|------------|
| столбцы         |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| дата            | месяца производства работ                               | дата       |

### Ключевые техника (тех. ресурсы)

| аттрибут        | описание                                                | тип данных |
|-----------------|---------------------------------------------------------|------------|
| строки          |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| фильтр          | фильтр, который определяет какие строки попадут в базу  | текст      |
| проект          | проект по справочнику                                   | текст      |
| подпроект       | подпроект по справочнику                                | текст      |
| вид техники     | наименование техники по справочнику                     | текст      |
| ед изм          | ед изм показателя (план, факт (м.ч.), факт (ед), Δ)     | текст      |
|-----------------|---------------------------------------------------------|------------|
| столбцы         |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| дата            | месяца производства работ                               | дата       |

## Аттрибуты базы

### Ключевые объемы
         
| аттрибут                                 | источник             | формула вычисления                     | тип данных |
|------------------------------------------|----------------------|----------------------------------------|------------|
| дата                                     | источник             |                                        | дата       |
| схема.год                                | схема, календарь     |                                        | текст      |
| схема.месяц год                          | схема, календарь     |                                        | текст      |
| проект                                   | источник             |                                        | текст      |
| подпроект                                | источник             |                                        | текст      |
| проект_key                               | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                             | схема, проект        |                                        | текст      |
| схема.подпроект                          | схема, проект        |                                        | текст      |
| организация                              | источник             |                                        | текст      |
| организация_key                          | вычисление           | lower(организация)                     | текст      |
| схема.организация                        | схема, организация   |                                        | текст      |
| ключевые                                 | источник             |                                        | текст      |
| ед изм                                   | источник             |                                        | текст      |
| ключевые_key                             | вычисление           | lower(ключевые) & "_" & lower(ед изм)  | текст      |
| схема.ключевые ур0 наименование с ед изм | схема, ключевые      |                                        | текст      |
| схема.ключевые ур0 вед поз               | схема, ключевые      |                                        | текст      |
| схема.ключевые ур1 наименование с ед изм | схема, ключевые      |                                        | текст      |
| схема.ключевые ур1 вед поз               | схема, ключевые      |                                        | текст      |
| схема.типовые_key                        | схема, ключевые      |                                        | текст      |
| схема.типовые наименование с ед изм      | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование с ед изм  | схема, типовые       |                                        | текст      |
| схема.типовые ур0 вед поз                | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование с ед изм  | схема, типовые       |                                        | текст      |
| схема.типовые ур1 вед поз                | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование с ед изм  | схема, типовые       |                                        | текст      |
| схема.типовые ур2 вед поз                | схема, типовые       |                                        | текст      |
| объем                                    | источник             |                                        | число      |
| имя файла                                | вычисление           | метаданные, имя файла                  | текст      |
| имя листа                                | вычисление           | метаданные, имя листа                  | текст      |
| время обновления база                    | вычисление           | метаданные, время обновления           | время      |

### Ключевые часы
         
| аттрибут                                 | источник             | формула вычисления                     | тип данных |
|------------------------------------------|----------------------|----------------------------------------|------------|
| дата                                     | источник             |                                        | дата       |
| схема.год                                | схема, календарь     |                                        | текст      |
| схема.месяц год                          | схема, календарь     |                                        | текст      |
| проект                                   | источник             |                                        | текст      |
| подпроект                                | источник             |                                        | текст      |
| проект_key                               | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                             | схема, проект        |                                        | текст      |
| схема.подпроект                          | схема, проект        |                                        | текст      |
| организация                              | источник             |                                        | текст      |
| организация_key                          | вычисление           | lower(организация)                     | текст      |
| схема.организация                        | схема, организация   |                                        | текст      |
| ключевые                                 | источник             |                                        | текст      |
| ед изм                                   | источник             |                                        | текст      |
| ключевые_key                             | вычисление           | lower(ключевые) & "_" & lower(ед изм)  | текст      |
| схема.ключевые ур0 наименование          | схема, ключевые      |                                        | текст      |
| схема.ключевые ур1 наименование          | схема, ключевые      |                                        | текст      |
| схема.типовые_key                        | схема, ключевые      |                                        | текст      |
| схема.типовые наименование               | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование           | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование           | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование           | схема, типовые       |                                        | текст      |
| люди                                     | источник             |                                        | число      |
| часы                                     | источник             |                                        | число      |
| имя файла                                | вычисление           | метаданные, имя файла                  | текст      |
| имя листа                                | вычисление           | метаданные, имя листа                  | текст      |
| время обновления база                    | вычисление           | метаданные, время обновления           | время      |

### Ключевые техника
         
| аттрибут                                 | источник             | формула вычисления                     | тип данных |
|------------------------------------------|----------------------|----------------------------------------|------------|
| дата                                     | источник             |                                        | дата       |
| схема.год                                | схема, календарь     |                                        | текст      |
| схема.месяц год                          | схема, календарь     |                                        | текст      |
| проект                                   | источник             |                                        | текст      |
| подпроект                                | источник             |                                        | текст      |
| проект_key                               | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                             | схема, проект        |                                        | текст      |
| схема.подпроект                          | схема, проект        |                                        | текст      |
| вид техники                              | источник             |                                        | текст      |
| наименование техники_key                 | источник             | lower(вид техники)                     | текст      |
| схема.наименование техники               | схема, техника       |                                        | текст      |
| схема.группа техники                     | схема, техника       |                                        | текст      |
| техника                                  | источник             |                                        | число      |
| часы                                     | источник             |                                        | число      |
| имя файла                                | вычисление           | метаданные, имя файла                  | текст      |
| имя листа                                | вычисление           | метаданные, имя листа                  | текст      |
| время обновления база                    | вычисление           | метаданные, время обновления           | время      |

*lower() -> меняет регистр на нижний и удляет ведущие пробелы* 

## Основные операции Power Query

1. получаем путь к файлам из таблицы с путями
2. из файла схема загружаем таблицы: проект, организация, типовые, классификатор, календарь
3. из инструмента загружаем таблицу с нормализацией поля "организация"
4. извлекаем содержимое папки с файлами ключевых (без вложенных папок)  
5. находим таблицы с ключевыми показателями. Допустимые имена листов: "ключевые объемы", "лр по видам работ", "тех.ресурсы"
6. создаем и применяем функцию которая преобразовывает файлы
    1. заменяем ошибки в файле
    2. поднимаем первую строку в заголовок
    3. нормализуем загловок: изменяем регистр на нижний и удаляем ведущие пробелы
    4. заполняем пропущенные данные для полей: проект, подпроект, организация, ключевые, ед изм, вид техники
    5. оставляем строки с маркером в поле "фильтр"
    6. переносим столбцы с датами в строки
    7. убираем строки без выполненных объемов / затраченных часов
7. для каждой таблицы с ключевыми показателями: ключевые часы, ключевыми объемы, ключевые техника
    1. исключаем из дальнейшего преобразования таблицы с ошибками во время предыдущей трансформации (список таблиц с ошибками выведен в отдельный шаг)
        1. для таблицы "лр по видам работ" переносим значения строк для "ч.ч.", "часы" в столбцы (pivot)
        2. для таблицы "тех.ресурсы" переносим значения строк для "план", "факт (м.ч.)", "факт (ед)", "Δ"  в столбцы (pivot) 
    2. создаем ключи
    3. заменяем . на , в числовых полях и изменяем тип данных
    4. переименовываем названия организаций для таблиц: "лр по видам работ" и "ключевые объемы" переименовываем названия организаций
    5. объединяем с таблицами из схемы
    6. добавляем дату обновления
    7. выбираем столбцы согласно "Аттрибуты базы"

## Метрики отчета

## Является источником для
- отчет Power BI
- модель

## Требование к ПО
- Microsoft Excel 2019 и выше
