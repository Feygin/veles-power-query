# Описание

## Описание проблемы

Для каждого проекта аналитик отдела мониторинга ежедневно собирает ключевые показатели: выполненные объемы работ, затраченные трудовые ресурсы и технические ресурсы. В качестве источников он использует отчеты субподрядных организаций. Источники не структированы, поэтому данные приходится обрабатывать вручную. На конец месяца они сводятся и переносятся в накопители. Их также три: ключевые объемы, людские ресурсы по видам работ и технические ресурсы. Накопители представляют собой формат сводных таблиц, где в строках хранятся аттрибуты работы: названия ключевых показателей, организаций, единиц техники и тд., а в столбцах: месяцы выполнения работ. На пересечение строк и столбцов заносятся ключевые показатели: объемы работ, трудовые и технические ресурсы.

Аналитик регулярно сверяет эти данные с другими отчетами компании. Эти данные сверяются в срезе проекта, подпроекта, организации и типовой позиции. Для каждого среза в компании создан отдельный справочник. Справочники хранятся отдельно и регулярно обновляются. Эти обновления, необходимость каждый раз сводить отчет и возможные ошибки при заполнении таблицы: неверный регистр, лишние пробелы, опечатки и тд. приводит к ошибкам при сведении отчета. 

Помимо этого аналитик рассчитывет производные показатели, например, фактический норматив = затраченным трудовым ресурсам / объем выполненной работы. Ему важно оперативно получать как значения за весь период строительства, так и за отдельный месяц. Существующий формат не позволяет оперативно вычислить эти метрики.  

Кроме этого руководству важно иметь перед глазами общий свод по всем проектам. Отчеты по проектам хранятся в отдельных файлах и для получения единого отчета необходимо сначала актуализировать все отчеты в файлах, рассчитать сводные показатели для проекта, а потом свести все эти данные в единую таблицу. Сейчас эту информацию ежемесячно собирает отдельно выделенный аналитик. Если данные по любому из проектов меняются, тогда необходимо внести соответствующие правки.

## Решение

Для решения задачи используем инструмент Power Query от Microsoft. С его помощью извлекаем данные из сводной двумерной таблицы и преобразовываем в длинный одномерный формат, объеденияем данные проектов в единую таблицу и обогащаем их информацией из справочников. 

Не смотря на то, что для отчета создан шаблон, от проекта к проекту он может видоизменяться. В него могут быть добавлены дополнительные столбцы и число месяцев отличается от проекта к проекту. Шапка состоит из нескольких строк с объединенными ячейками, что приводит к дополнительным трудностям для обработки. Помимо этого в таблицах рассчитываются промежуточные итоги по строкам и столбцам, а на одном листе может находиться несколько таблиц по подпроектам, которые разделенны пустыми строками. 

Для решения проблемы было принято решение добавить первой строкой пользовательскую шапку в которой аналитик указывает столбцы которые необходимо извлечь. Если он указал название столбца или месяца в формате даты, то эти данные попадут в базу, в противном случае они не будут извлечены. Для исключения из базы промежуточных итогов добавлен пользовательский столбец "фильтр" в котором аналитик отмечает строки подлежащие включению в базу. 

## Источники

- папка с файлами баз ключевых часов за месяц, формата xlsx
- справочник(схема)

## Требования для загрузки

### Названия листов в файле Excel

- Ключевые объемы
- ЛР по видам работ
- Тех.Ресурсы

- Пользовательская первая строка. Для каждого листа создан свой шаблон строки.

## Чек-лист если не работает

## Структура листов инструмента

### перед первым запуском

Инструкция по отключению конфицендиальности power query

### параметры

Здесь задаем пути к источникам

### нормализация

### статус извлечения

### ошибки


### ключевые объемы

Результат извлечения из листов "Ключевые объемы"

### ключевые часы

Результат извлечения из листов "ЛР по видам работ"

### ключевые техника

Результат извлечения из листов "Тех.Ресурсы"

## Аттрибуты источника

### Ключевые объемы

| аттрибут        | описание                                                | тип данных |
|-----------------|---------------------------------------------------------|------------|
| строки          |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| фильтр          | фильтр, который определяет какие строки попадут в базу  | текст      |
| проект          | проект по справочнику                                   | текст      |
| подпроект       | подпроект по справочнику                                | текст      |
| ключевые        | наименование ключевой позиции по справочнику            | текст      |
| организация     | организация (можно нормализовать)                       | текст      |
| ед изм          | единица измерения ключевой позици по справочнику        | текст      |
|-----------------|---------------------------------------------------------|------------|
| столбцы         |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| дата            | месяца производства работ                               | дата       |

### Ключевые часы (лр по видам работ)

| аттрибут        | описание                                                | тип данных |
|-----------------|---------------------------------------------------------|------------|
| строки          |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| фильтр          | фильтр, который определяет какие строки попадут в базу  | текст      |
| проект          | проект по справочнику                                   | текст      |
| подпроект       | подпроект по справочнику                                | текст      |
| ключевые        | наименование ключевой позиции по справочнику            | текст      |
| организация     | организация (можно нормализовать)                       | текст      |
| ключевые ед изм | единица измерения ключевой позици по справочнику        | текст      |
| ед изм          | единица измерения показателя (ч.ч, чел.)                | текст      |
|-----------------|---------------------------------------------------------|------------|
| столбцы         |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| дата            | месяца производства работ                               | дата       |

### Ключевые техника (тех. ресурсы)

| аттрибут        | описание                                                | тип данных |
|-----------------|---------------------------------------------------------|------------|
| строки          |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| фильтр          | фильтр, который определяет какие строки попадут в базу  | текст      |
| проект          | проект по справочнику                                   | текст      |
| подпроект       | подпроект по справочнику                                | текст      |
| вид техники     | наименование техники по справочнику                     | текст      |
| ед изм          | ед изм показателя (план, факт (м.ч.), факт (ед), Δ)     | текст      |
|-----------------|---------------------------------------------------------|------------|
| столбцы         |                                                         |            |
|-----------------|---------------------------------------------------------|------------|
| дата            | месяца производства работ                               | дата       |

## Аттрибуты базы

### Ключевые объемы
         
| аттрибут                                 | источник             | формула вычисления                     | тип данных |
|------------------------------------------|----------------------|----------------------------------------|------------|
| дата                                     | источник             |                                        | дата       |
| схема.год                                | схема, календарь     |                                        | текст      |
| схема.месяц год                          | схема, календарь     |                                        | текст      |
| проект                                   | источник             |                                        | текст      |
| подпроект                                | источник             |                                        | текст      |
| проект_key                               | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                             | схема, проект        |                                        | текст      |
| схема.подпроект                          | схема, проект        |                                        | текст      |
| организация                              | источник             |                                        | текст      |
| организация_key                          | вычисление           | lower(организация)                     | текст      |
| схема.организация                        | схема, организация   |                                        | текст      |
| ключевые                                 | источник             |                                        | текст      |
| ед изм                                   | источник             |                                        | текст      |
| ключевые_key                             | вычисление           | lower(ключевые) & "_" & lower(ед изм)  | текст      |
| схема.ключевые ур0 наименование с ед изм | схема, ключевые      |                                        | текст      |
| схема.ключевые ур0 вед поз               | схема, ключевые      |                                        | текст      |
| схема.ключевые ур1 наименование с ед изм | схема, ключевые      |                                        | текст      |
| схема.ключевые ур1 вед поз               | схема, ключевые      |                                        | текст      |
| схема.типовые_key                        | схема, ключевые      |                                        | текст      |
| схема.типовые наименование с ед изм      | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование с ед изм  | схема, типовые       |                                        | текст      |
| схема.типовые ур0 вед поз                | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование с ед изм  | схема, типовые       |                                        | текст      |
| схема.типовые ур1 вед поз                | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование с ед изм  | схема, типовые       |                                        | текст      |
| схема.типовые ур2 вед поз                | схема, типовые       |                                        | текст      |
| объем                                    | источник             |                                        | число      |
| имя файла                                | вычисление           | метаданные, имя файла                  | текст      |
| время обновления база                    | вычисление           | метаданные, время обновления           | время      |

### Ключевые часы
         
| аттрибут                                 | источник             | формула вычисления                     | тип данных |
|------------------------------------------|----------------------|----------------------------------------|------------|
| дата                                     | источник             |                                        | дата       |
| схема.год                                | схема, календарь     |                                        | текст      |
| схема.месяц год                          | схема, календарь     |                                        | текст      |
| проект                                   | источник             |                                        | текст      |
| подпроект                                | источник             |                                        | текст      |
| проект_key                               | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                             | схема, проект        |                                        | текст      |
| схема.подпроект                          | схема, проект        |                                        | текст      |
| организация                              | источник             |                                        | текст      |
| организация_key                          | вычисление           | lower(организация)                     | текст      |
| схема.организация                        | схема, организация   |                                        | текст      |
| ключевые                                 | источник             |                                        | текст      |
| ед изм                                   | источник             |                                        | текст      |
| ключевые_key                             | вычисление           | lower(ключевые) & "_" & lower(ед изм)  | текст      |
| схема.ключевые ур0 наименование          | схема, ключевые      |                                        | текст      |
| схема.ключевые ур1 наименование          | схема, ключевые      |                                        | текст      |
| схема.типовые_key                        | схема, ключевые      |                                        | текст      |
| схема.типовые наименование               | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование           | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование           | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование           | схема, типовые       |                                        | текст      |
| люди                                     | источник             |                                        | число      |
| часы                                     | источник             |                                        | число      |
| имя файла                                | вычисление           | метаданные, имя файла                  | текст      |
| время обновления база                    | вычисление           | метаданные, время обновления           | время      |


## Основные операции Power Query

. получаем путь к файлам из таблицы с путями
. из файла схема загружаем таблицы: проект, организация, типовые, классификатор, календарь
. из файла с запросом загружаем таблицу с нормализацией поля "организация"
. извлекаем содержимое папки с файлами ключевых показателей (без вложенных папок)  
    1. выводим в отдельный шаг таблицы которые не были извлечены
. оставляем таблицы с ключевыми показателями. Допустимые имена листов: "ключевые объемы", "лр по видам работ", "тех.ресурсы"
. создаем и применяем функцию с преобразованием файлов
    . заменяем ошибки в файле
    . поднимаем первую строку в заголовок
    . нормализуем загловок: изменяем регистр на нижний и удаляем ведущие пробелы
    . заполняем пропущенные данные для полей: проект, подпроект, организация, ключевые, ед изм, вид техники
    . убираем строки у которых отсутсвует маркер в поле "фильтр"
    . трансформируем столбцы с датами в строки
    . убираем строки без выполненных объемов / затраченных часов
. для каждой таблицы с ключевыми показателями: ключевые часы, ключевыми объемы, ключевые техника
    . исключаем из дальнейшего преобразования таблицы с ошибками во время предыдущей трансформации (список таблиц с ошибками выведен в отдельный шаг)
        . для таблицы "лр по видам работ" трансформируем атрибуты ед изм ("ч.ч.", "часы") в столбцы
    . создаем ключи
    . переименовываем названия организаций. Новые названия заданы в таблице переименований на листе "нормализация".
    . обогащаем данными из схемы
    . выбираем столбцы согласно "Аттрибуты базы"



5. нормализуем названия заголовков таблицы: изменяем регистр на нижний и удаляем ведущие пробелы
6. объединяем таблицы по полям из перечня "Аттрибуты источника"  
    1. выводим в отдельный шаг ошибки в таблицах
7. в числовых столбцах заменяем "." на "," 
8. изменяем тип данных согласно перечню "Аттрибуты источника"
9. создаем ключи для полей: "проект", "подпроект", "организация", "классификатор", "типовые"
10. объединяем с таблицами из схемы
11. раздеяем на две таблицы: 1к1н и дополнительные часы. Разделение производим по значениям "1к", "1н" по полю "классификатор_key".  
    1. для таблицы 1к1н оставляем строки с классификаторами 1к 1н и производим pivot  
    2. для таблицы дополнительных часов убираем классификаторы 1к 1н

## Метрики отчета

## Является источником для
- отчет Power BI
- модель

## Требование к ПО
- Microsoft Excel 2019 и выше
