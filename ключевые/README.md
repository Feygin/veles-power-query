# Описание
## Описание проблемы
Для каждого проекта аналитик отдела мониторинга ежедневно собирает ключевые показатели: выполненные объемы работ, затраченные трудовые ресурсы и технические ресурсы. В качестве источников он использует отчеты субподрядных организаций. Источники не структированы, поэтому данные приходится обрабатывать вручную. На конец месяца они сводятся и переносятся в накопители. Их также три: ключевые объемы, людские ресурсы по видам работ и технические ресурсы. Накопители представляют собой формат сводных таблиц, где в строках хранятся аттрибуты работы: названия ключевых показателей, организаций, единиц техники и тд., а в столбцах: месяцы выполнения работ. На пересечение строк и столбцов заносятся ключевые показатели: объемы работ, трудовые и технические ресурсы.

Аналитик регулярно сверяет эти данные с другими отчетами компании. Эти данные сверяются в срезе проекта, подпроекта, организации и типовой позиции. Для каждого среза в компании создан отдельный справочник. Справочники хранятся отдельно и регулярно обновляются. Эти обновления, необходимость каждый раз сводить отчет и возможные ошибки при заполнении таблицы: неверный регистр, лишние пробелы, опечатки и тд. приводит к ошибкам при сведении отчета. 

Помимо этого аналитик рассчитывет производные показатели, например, фактический норматив = затраченным трудовым ресурсам / объем выполненной работы. Ему важно оперативно получать как значения за весь период строительства, так и за отдельный месяц. Существующий формат не позволяет оперативно вычислить эти метрики.  

Кроме этого руководству важно иметь перед глазами общий свод по всем проектам. Отчеты по проектам хранятся в отдельных файлах и для получения единого отчета необходимо сначала актуализировать все отчеты в файлах, рассчитать сводные показатели для проекта, а потом свести все эти данные в единую таблицу. Сейчас эту информацию ежемесячно собирает отдельно выделенный аналитик. Если данные по любому из проектов меняются, тогда необходимо внести соответствующие правки.

## Решение
Для решения задачи используем инструмент Power Query от Microsoft. С его помощью извлекаем данные из сводной двумерной таблицы и преобразовываем в длинный одномерный формат, объеденияем данные проектов в единую таблицу и обогащаем их информацией из справочников. 

Не смотря на то, что для отчета создан шаблон, от проекта к проекту он может видоизменяться. В него могут быть добавлены дополнительные столбцы и число месяцев отличается от проекта к проекту. Шапка состоит из нескольких строк с объединенными ячейками, что приводит к дополнительным трудностям для обработки. Помимо этого в таблицах рассчитываются промежуточные итоги по строкам и столбцам, а на одном листе может находиться несколько таблиц по подпроектам, которые разделенны пустыми строками. 

Для решения проблемы было принято решение добавить первой строкой пользовательскую шапку в которой аналитик указывает столбцы которые необходимо извлечь. Если он указал название столбца или месяца в формате даты, то эти данные попадут в базу, в противном случае они не будут извлечены. Для исключения из базы промежуточных итогов добавлен пользовательский столбец "фильтр" в котором аналитик отмечает строки подлежащие включению в базу. 

## Источники
- папка с файлами баз ключевых часов за месяц, формата xlsx
- справочник(схема)

## Требования для загрузки

### Названия листов в файле Excel
- Ключевые объемы
- ЛР по видам работ
- Тех.Ресурсы

- Пользовательская первая строка. Для каждого листа создан свой шаблон строки.

## Чек-лист если не работает

## Структура листов инструмента

### перед первым запуском
Инструкция по отключению конфицендиальности power query

### параметры
Здесь задаем пути к источникам

### нормализация

### статус извлечения

### ошибки


### ключевые объемы
Результат извлечения из листов "Ключевые объемы"

### ключевые часы
Результат извлечения из листов "ЛР по видам работ"

### ключевые техника
Результат извлечения из листов "Тех.Ресурсы"

## Аттрибуты источника

###
| аттрибут        | описание                                 | тип данных |
|-----------------|------------------------------------------|------------|
| дата            | месяц выполнения работы  (начало месяца) | дата       |
| проект          | проект по справочнику                    | текст      |
| подпроект       | подпроект по справочнику                 | текст      |
| организация     | организация по справочнику               | текст      |
| классификатор   | классификатор работы по справочнику      | текст      |
| работа описание | описание выполненной работы              | текст      |
| работа группа   | шифр дисциплины                          | текст      |
| типовые         | типовой код по справочнику               | текст      |
| часы            | затраченные людские ресурсы              | число      |
| стоимость руб   | стоиомость работы в рублях               | число      |

## Аттрибуты базы
| аттрибут                        | источник             | формула вычисления                     | тип данных |
|---------------------------------|----------------------|----------------------------------------|------------|
| дата                            | источник             |                                        | дата       |
| схема.год                       | схема, календарь     |                                        | текст      |
| схема.месяц                     | схема, календарь     |                                        | текст      |
| проект                          | источник             |                                        | текст      |
| подпроект                       | источник             |                                        | текст      |
| проект_key                      | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                    | схема, проект        |                                        | текст      |
| схема.подпроект                 | схема, проект        |                                        | текст      |
| организация                     | источник             |                                        | текст      |
| организация_key                 | вычисление           | lower(организация)                     | текст      |
| схема.организация               | схема, организация   |                                        | текст      |
| классификатор                   | источник             |                                        | текст      |
| классификатор_key               | вычисление           | lower(классификатор)                   | текст      |
| схема.классификатор с описанием | схема, классификатор |                                        | текст      |
| работа описание                 | источник             |                                        | текст      |
| работа группа                   | источник             |                                        | текст      |
| типовые                         | источник             |                                        | текст      |
| типовые_key                     | вычисление           | lower(типовые)                         | текст      |
| схема.типовые наименование      | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование  | схема, типовые       |                                        | текст      |
| часы                            | источник             |                                        | число      |
| стоимость руб                   | источник             |                                        | число      |
| имя файла                       | вычисление           | метаданные, имя файла                  | текст      |


## Основные операции Power Query


## Метрики отчета

## Является источником для
- отчет Power BI
- модель

## Требование к ПО
- Microsoft Excel 2019 и выше
