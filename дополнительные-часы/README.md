# Описание

## Описание проблемы

Для каждого проекта аналитик ведет отдельную таблицу с информацией о затраченных дополнительных часах на выполнение строительно-монтажных работ. Каждый месяц он запрашивает подписанные отчеты (ВЛР) у субподрядчика и добавляет их в таблицу. Так получается накопитель, где можно посмотреть информацию о затраченных дополнительных часах за весь период строительства. 

В конце каждого месяца отдел формирует единый отчет по всем проектам. В этом отчете смотрят показатели по следующиям группам:
- месяц
- типовая позиция (ур. 0 - 1)
- классификатор
- организация  

В накопителе задаются коды групп, а описание и поля для группировки хранятся в отдельных таблицах. Эти таблицы называются справочниками и регулярно обновляются. Чтобы получить единый отчет по всем проектам необходимо:
1. актуализировать информацию в накопителе
2. соотнести шифры накопителя с шифрами справочников
    - мешают опечатки: неверный регистр, лишние пробелы и тд.; регуляное обновление справочников
3. рассчитать сводные показатели для проекта
4. свести отчеты по всем проектам в единый файл
5. записать результат в google sheets
6. при изменении данных в источнике - актуализировать п.5

Другой отчет компании - отчет KPI. KPI = отношение фактических часов к нормативным. Чтобы рассчитать KPI:
1. аналитик запрашивает табельные и нормативные часы у субподрядной организации
    - табельные часы - часы по рабочему табелю, они включают в себя фактические часы на выполнение проектных работ и дополнительные часы. 
    - нормативные часы - часы которые необходимо затратить работнику на выполнение проектных работ по норме. Они включают в себя дополнительные работы в соотношении 1 час = 1 нормочас.
2. из значений табльных и нормативных часов вычитаются дополнительные и получаются показатели 1к и 1н соответственно
3. рассчитывается KPI = 1к / 1н  
Сейчас показатели 1к и 1н хранятся в накопителе. Они вычисляются в отдельных строках в конце каждого месяца. Чтобы различать эти строки от значений дополнительных часов им присвоены фиктивные значения классификтора 1к, 1н. Это приводит к сложности в формировании части отчетов так как из расчетов приходится исключать эти строки.

## Определение сделанного (DoD)

Аналитику доступен инструмент при помощи которого он получает единую таблицу по дополнительным часам и часам 1к 1н:
- реализована проверка полноты извлечения
- реализована проверка отсутсвия потери данных при извлечении
- данные обогащены значениями из справочника, выполнена нормализация ключей по которым производится объединение
- текстовой инструкции достаточно, чтобы понять как работает инструмент

## Решение

Для решения задачи используем инструмент Power Query от Microsoft. С его помощью объеденияем данные из проектов в единую таблицу и обогащаем их информацией из справочников. Для того, чтобы с данными было удобно работать они делятся на две таблицы: с дополнительными часами и показателями 1к, 1н. Эти табицы служат источником для отчета по проектам в Power BI и других отчетов в которых используются дополнительные часы.

## Источники

- папка с файлами баз дополнительных часов по проектам, формата xlsx
- справочник(схема)

## Требования для загрузки

- файлы дополнительных часов в формате xlsx
- файл схема
- имя таблицы с дополнительными часами: "доп_часы" или "дополнительные_часы" или "_доп_часы_шаблон"

## Как запускать

Запускаем запрос через Данные -> Обновить Все (Data -> Refresh All)

## Чек-лист если не работает

- проверяем отключение конфиденциальности (см лист "перед первым запуском")
- проверяем корректность ссылок на листе параметры
    - ссылки вставлены без кавычек
    - для схемы указываем ссылку на файл, для дополнительных часов на папку
- проверяем версию excel
- книгу обновляем через "Обновить все"
- что-то не подтянулось их схемы
    - проверяем соответствие значений у схемы и файлов по ключам "XXXXXX_key"
    - если какие-то ключи не сходятся исправляем источник или заносим новые данные в справочник

## Структура инструмента

### перед первым запуском

Инструкция по отключению конфиденциальности

### параметры

Задаем путь к схеме и папке с дополнительными часами

### статус извлечения

Проверяем, что из всех файлов были извлечены таблицы с дополнительными часами

### ошибки

Проверяем, отсутсвие ошибок при извлеченииданных. В основном появляются при изменении типа данных.

### дополнительные часы

Объединенная таблица с дополнительными часами и присоединенной схемой. Классификаторы 1к1н убраны.

### 1к1н

Объединенная таблица с классификаторами 1к1н и присоединенной схемой.

### отчет

Сводный отчет.

## Аттрибуты источника

| аттрибут        | описание                                 | тип данных |
|-----------------|------------------------------------------|------------|
| дата            | месяц выполнения работы  (начало месяца) | дата       |
| проект          | проект по справочнику                    | текст      |
| подпроект       | подпроект по справочнику                 | текст      |
| организация     | организация по справочнику               | текст      |
| классификатор   | классификатор работы по справочнику      | текст      |
| работа описание | описание выполненной работы              | текст      |
| работа группа   | шифр дисциплины                          | текст      |
| типовые         | типовой код по справочнику               | текст      |
| часы            | затраченные людские ресурсы              | число      |
| стоимость руб   | стоиомость работы в рублях               | число      |

## Аттрибуты базы

| аттрибут                        | источник             | формула вычисления                     | тип данных |
|---------------------------------|----------------------|----------------------------------------|------------|
| дата                            | источник             |                                        | дата       |
| схема.год                       | схема, календарь     |                                        | текст      |
| схема.месяц год                 | схема, календарь     |                                        | текст      |
| проект                          | источник             |                                        | текст      |
| подпроект                       | источник             |                                        | текст      |
| проект_key                      | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                    | схема, проект        |                                        | текст      |
| схема.подпроект                 | схема, проект        |                                        | текст      |
| организация                     | источник             |                                        | текст      |
| организация_key                 | вычисление           | lower(организация)                     | текст      |
| схема.организация               | схема, организация   |                                        | текст      |
| классификатор                   | источник             |                                        | текст      |
| классификатор_key               | вычисление           | lower(классификатор)                   | текст      |
| схема.классификатор с описанием | схема, классификатор |                                        | текст      |
| работа описание                 | источник             |                                        | текст      |
| работа группа                   | источник             |                                        | текст      |
| типовые                         | источник             |                                        | текст      |
| типовые_key                     | вычисление           | lower(типовые)                         | текст      |
| схема.типовые наименование      | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование  | схема, типовые       |                                        | текст      |
| часы                            | источник             |                                        | число      |
| стоимость руб                   | источник             |                                        | число      |
| имя файла                       | вычисление           | метаданные, имя файла                  | текст      |

## Основные операции Power Query

1. получаем путь к файлам из таблицы с путями
2. из файла схема загружаем таблицы: проект, организация, типовые, классификатор, календарь
3. извлекаем содержимое папки с файлами дополнительных часов (без вложенных папок)  
    1. выводим в отдельный шаг таблицы которые не были извлечены
4. выбираем таблицу с дополнительными часами по одному из допустимому имени: "доп_часы", "дополнительные_часы", "_доп_часы_шаблон"
5. нормализуем названия заголовков таблицы: изменяем регистр на нижний и удаляем ведущие пробелы
6. объединяем таблицы по полям из перечня "Аттрибуты источника"  
    1. выводим в отдельный шаг ошибки в таблицах
7. в числовых столбцах заменяем "." на "," 
8. изменяем тип данных согласно перечню "Аттрибуты источника"
9. создаем ключи для полей: "проект", "подпроект", "организация", "классификатор", "типовые"
10. объединяем с таблицами из схемы
11. раздеяем на две таблицы: 1к1н и дополнительные часы. Разделение производим по значениям "1к", "1н" по полю "классификатор_key".  
    1. для таблицы 1к1н оставляем строки с классификаторами 1к 1н и производим pivot  
    2. для таблицы дополнительных часов убираем классификаторы 1к 1н

## Метрики отчета

## Является источником для

- отчет Power BI
- модель

## Требование к ПО

- Microsoft Excel 2019 и выше