# Описание
## Описание проблемы
Для каждого проекта аналитик ведет отдельную таблицу с информацией о затраченных дополнительных часах на выполнение строительно-монтажных работ. Каждый месяц он запрашивает подписанные отчеты (ВЛР) у субподрядчика и добавляет их в таблицу. Так получается накопитель, где можно посмотреть информацию о затраченных дополнительных часах за весь период строительства. 

Регулярной задачей аналитика является формирование отчетов о понесенных трудозатрах. Эти отчеты строятся в различных разрезах: типовые позиции, классификаторы, проекты и тд. Для того, чтобы сравнивать различные отчеты компании между собой для каждого из разреза создан единый справочник. Справочники хранятся отдельно и регулярно обновляются. Эти обновления и возможные ошибки при заполнении таблицы: неверный регистр, лишние пробелы, опечатки и тд., приводит к ошибкам при сведении отчета. 

Кроме этого руководству важно иметь перед глазами общий свод по всем проектам. Отчеты по проектам хранятся в отдельных файлах и для получения единого отчета необходимо сначала актуализировать все отчеты в файлах, рассчитать сводные показатели для проекта, а потом свести все эти данные в единую таблицу. Сейчас эту информацию ежемесячно собирает отдельно выделенный аналитик и публикует в google sheets. Если данные по любому из проектов меняются аналитик обязан уведомить об этом и внести корректировки.

Другим важным отчетом в компании является показатель эффективности. Он рассчитвается как отношение фактических часов к нормативным. Чтобы рассчитать этот показатель аналитик сначала запрашивает табельные и нормативные часы у субподрядной организации. Табельные часы - часы по рабочему табелю, они включают в себя фактические часы на выполнение проектных работ и дополнительные часы. Нормативные часы - часы которые необходимо затратить работнику на выполнение проектных работ по норме. Они также включают в себя дополнительные работы в соотношении 1 час = 1 нормочас. Далее аналитик вычитает из значений фактических и нормативных часов дополнительные и получает показатели 1к и 1н соответственно. Показатель эффективности рассчитывается как отношение 1к к 1н. Существующая методика рассчета подразумевает, что эти показатели хранятся в одной таблице с дополнительными часами. Это приводит к сложности в формировании отчетов по дополнительным часам так как требуется исключать из части расчетов показатели 1к, 1н.

## Определение сделанного (DoD)
Аналитику доступен инструмент при помощи которого он объединяет базы дополнительных часов:
- реализована проверка полноты извлечения
- реализована проверка отсутсвия потери данных при извлечении
- данные обогащены значениями из справочника, выполнена нормализация ключей по которым производится объединение
- классификаторы 1к1н выведены в отдельную таблицу 
- текстовой инструкции достаточно, чтобы понять как работает инструмент

## Решение
Для решения задачи используем инструмент Power Query от Microsoft. С его помощью объеденияем данные из проектов в единую таблицу и обогащаем их информацией из справочников. Для того, чтобы с данными было удобно работать они делятся на две таблицы: с дополнительными часами и показателями 1к, 1н. Эти табицы служат источником для отчета по проектам в Power BI и других отчетов в которых используются дополнительные часы.

## Источники
- папка с файлами баз дополнительных часов по проектам, формата xlsx
- справочник(схема)

## Требования для загрузки
- файлы дополнительных часов в формате xlsx
- файл схема
- имя таблицы с дополнительными часами: "доп_часы" или "дополнительные_часы" или "_доп_часы_шаблон"

## Как запускать
Запускаем запрос через Данные -> Обновить Все (Data -> Refresh All)

## Чек-лист если не работает
- проверяем отключение конфиденциальности (см лист "перед первым запуском")
- проверяем корректность ссылок на листе параметры
    - ссылки вставлены без кавычек
    - для схемы указываем ссылку на файл, для дополнительных часов на папку
- проверяем версию excel
- книгу обновляем через "Обновить все"
- что-то не подтянулось их схемы
    - проверяем соответствие значений у схемы и файлов по ключам "XXXXXX_key"
    - если какие-то ключи не сходятся исправляем источник или заносим новые данные в справочник

## Структура инструмента

### перед первым запуском
Инструкция по отключению конфиденциальности

### параметры
Задаем путь к схеме и папке с дополнительными часами

### статус извлечения
Проверяем, что из всех файлов были извлечены таблицы с дополнительными часами

### ошибки
Проверяем, отсутсвие ошибок при извлеченииданных. В основном появляются при изменении типа данных.

### дополнительные часы
Объединенная таблица с дополнительными часами и присоединенной схемой. Классификаторы 1к1н убраны.

### 1к1н
Объединенная таблица с классификаторами 1к1н и присоединенной схемой.

### отчет
Сводный отчет.

## Аттрибуты источника
| аттрибут        | описание                                 | тип данных |
|-----------------|------------------------------------------|------------|
| дата            | месяц выполнения работы  (начало месяца) | дата       |
| проект          | проект по справочнику                    | текст      |
| подпроект       | подпроект по справочнику                 | текст      |
| организация     | организация по справочнику               | текст      |
| классификатор   | классификатор работы по справочнику      | текст      |
| работа описание | описание выполненной работы              | текст      |
| работа группа   | шифр дисциплины                          | текст      |
| типовые         | типовой код по справочнику               | текст      |
| часы            | затраченные людские ресурсы              | число      |
| стоимость руб   | стоиомость работы в рублях               | число      |

## Аттрибуты базы
| аттрибут                        | источник             | формула вычисления                     | тип данных |
|---------------------------------|----------------------|----------------------------------------|------------|
| дата                            | источник             |                                        | дата       |
| схема.год                       | схема, календарь     |                                        | текст      |
| схема.месяц год                 | схема, календарь     |                                        | текст      |
| проект                          | источник             |                                        | текст      |
| подпроект                       | источник             |                                        | текст      |
| проект_key                      | вычисление           | lower(проект) & "_" & lower(подпроект) | текст      |
| схема.проект                    | схема, проект        |                                        | текст      |
| схема.подпроект                 | схема, проект        |                                        | текст      |
| организация                     | источник             |                                        | текст      |
| организация_key                 | вычисление           | lower(организация)                     | текст      |
| схема.организация               | схема, организация   |                                        | текст      |
| классификатор                   | источник             |                                        | текст      |
| классификатор_key               | вычисление           | lower(классификатор)                   | текст      |
| схема.классификатор с описанием | схема, классификатор |                                        | текст      |
| работа описание                 | источник             |                                        | текст      |
| работа группа                   | источник             |                                        | текст      |
| типовые                         | источник             |                                        | текст      |
| типовые_key                     | вычисление           | lower(типовые)                         | текст      |
| схема.типовые наименование      | схема, типовые       |                                        | текст      |
| схема.типовые ур0 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур1 наименование  | схема, типовые       |                                        | текст      |
| схема.типовые ур2 наименование  | схема, типовые       |                                        | текст      |
| часы                            | источник             |                                        | число      |
| стоимость руб                   | источник             |                                        | число      |
| имя файла                       | вычисление           | метаданные, имя файла                  | текст      |

## Основные операции Power Query
1. получаем путь к файлам из таблицы с путями
2. из файла схема загружаем таблицы: проект, организация, типовые, классификатор, календарь
3. извлекаем содержимое папки с файлами дополнительных часов (без вложенных папок)
    3.1. выводим в отдельный шаг таблицы которые не были извлечены
4. выбираем таблицу с дополнительными часами по одному из допустимому имени: "доп_часы", "дополнительные_часы", "_доп_часы_шаблон"
5. нормализуем названия заголовков таблицы: изменяем регистр на нижний и удаляем ведущие пробелы
6. объединяем таблицы по полям из перечня "Аттрибуты источника"
    6.1. выводим в отдельный шаг ошибки в таблицах
7. в числовых столбцах заменяем "." на "," 
8. изменяем тип данных согласно перечню "Аттрибуты источника"
9. создаем ключи для полей: "проект", "подпроект", "организация", "классификатор", "типовые"
10. объединяем с таблицами из схемы
11. раздеяем на две таблицы: 1к1н и дополнительные часы. Разделение производим по значениям "1к", "1н" по полю "классификатор_key".
    11.1. для таблицы 1к1н оставляем строки с классификаторами 1к 1н и производим pivot
    11.2. для таблицы дополнительных часов убираем классификаторы 1к 1н

## Метрики отчета

## Является источником для
- отчет Power BI
- модель

## Требование к ПО
- Microsoft Excel 2019 и выше